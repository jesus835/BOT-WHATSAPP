<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - Bot WhatsApp</title>
    <style>
        @font-face {
            font-family: 'NeueHaasGrotText';
            src: url('images/NeueHaasGrotText-65Medium-Trial.otf') format('opentype');
            font-weight: 500;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'VanillaPancake';
            src: url('images/Vanilla Pancake.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #2c2c2c;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header Superior */
        .top-header {
            background: #3a3a3a;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-bottom: 1px solid #2c2c2c;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: -0.7%;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            background: #0cc71b;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
            font-weight: bold;
            font-size: 18px;
        }

        .header-logo img {
            filter: brightness(0) invert(98.5%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(101%) contrast(100%);
            width: 32px;
            height: 32px;
            object-fit: contain;
            margin-left: 6%;
            transform: translateX(2%);
        }

        .header-title {
            font-size: 24px;
            font-weight: 300;
            color: #ffffff;
            font-family: 'NeueHaasGrotText', sans-serif;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-btn {
            padding: 8px 16px;
            background: #0cc71b;
            color: black;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .header-btn:hover {
            background: #0066cc;
        }

        .header-btn img {
            width: 20px;
            height: 20px;
            object-fit: contain;
            filter: brightness(0) saturate(100%) invert(100%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(1);
        }

        /* Botón de recargar sin fondo azul y con imagen negra */
        #btnRecargar {
            background: transparent;
            padding: 8px;
        }

        #btnRecargar:hover {
            background: #f0f2f5;
        }

        #btnRecargar img {
            width: 31px;
            height: 31px;
            filter: brightness(0) saturate(100%) invert(100%);
        }

        /* Botón de cerrar sesión sin fondo azul y con imagen negra */
        #btnCerrarSesion {
            background: transparent;
            padding: 8px;
        }

        #btnCerrarSesion:hover {
            background: #f0f2f5;
        }

        #btnCerrarSesion img {
            width: 31px;
            height: 31px;
            filter: brightness(0) saturate(100%) invert(100%);
        }

        .header-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .header-icon:hover {
            background: #e4e6eb;
        }

        .profile-pic {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }

        /* Container Principal */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            min-height: calc(100vh - 80px);
            height: calc(100vh - 80px);
            max-height: calc(100vh - 80px);
        }

        /* Sidebar de Navegación (Izquierda muy estrecha) */
        .nav-sidebar {
            width: 60px;
            background: #3a3a3a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            gap: 20px;
            border-right: 1px solid #2c2c2c;
        }

        .nav-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #65676b;
            font-size: 20px;
        }

        .nav-icon:hover {
            background: #4a4a4a;
        }

        .nav-icon.active {
            background: #4a4a4a;
            color: black;
        }

        .nav-icon.active:hover {
            background: #555555;
        }

        /* Estilos para imágenes cuando NO están seleccionadas - Color blanco */
        .nav-icon:not(.active) img {
            filter: brightness(0) saturate(100%) invert(100%);
        }

        /* Estilos para imágenes cuando SÍ están seleccionadas - Gris claro */
        .nav-icon.active img {
            filter: grayscale(1) brightness(1.5);
        }


        /* Sidebar de Chats (Izquierda más ancha) */
        .chats-sidebar {
            width: 320px;
            background: #3a3a3a;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #2c2c2c;
            overflow: hidden;
            border-radius: 30px;
            margin: 1%;
        }

        .user-profile {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #2c2c2c;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            background: #a1db2d;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
            font-weight: 600;
            font-size: 18px;
            overflow: visible;
            position: relative;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .user-avatar .verified-badge {
            position: absolute;
            bottom: -4px;
            right: -4px;
            width: 22.5px;
            height: 22.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .user-avatar .verified-badge img {
            width: 17.5px;
            height: 17.5px;
            object-fit: contain;
            border-radius: 0;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 15px;
            color: #ffffff;
            margin-bottom: 2px;
        }

        .user-username {
            font-size: 13px;
            color: #aaaaaa;
        }

        .user-menu {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-menu:hover {
            background: #4a4a4a;
        }

        .search-container {
            padding: 12px;
            border-bottom: 1px solid #2c2c2c;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: none;
            background: #2c2c2c;
            color: #ffffff;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }

        .search-input::placeholder {
            color: #888888;
        }

        .search-wrapper {
            position: relative;
        }

        .search-icon-absolute {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            object-fit: contain;
            filter: brightness(0) saturate(100%) invert(43%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(0.5);
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #2c2c2c;
        }

        .chat-item:hover {
            background: #4a4a4a;
        }

        .chat-item.active {
            background: #505050;
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            background: #a1db2d;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
        }

        .chat-content {
            flex: 1;
            min-width: 0;
        }

        .chat-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            color: #ffffff;
        }

        .chat-time {
            font-size: 12px;
            color: #aaaaaa;
        }

        .chat-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-preview {
            font-size: 14px;
            color: #aaaaaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #31a24c;
            font-weight: 500;
        }

        .chat-badge {
            background: #a1db2d;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }

        .check-icon {
            color: #6da298;
            font-size: 11px;
            letter-spacing: -2px;
            display: inline-block;
        }

        /* Área Principal de Chat */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #3a3a3a;
            position: relative;
            /* Asegurar que el área de chat tenga altura limitada */
            min-height: 0;
            max-height: calc(100vh - 80px);
            overflow: hidden;
            border-radius: 30px;
            margin: 1%;
        }

        .chat-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 40px,
                rgba(0,0,0,0.02) 40px,
                rgba(0,0,0,0.02) 41px
            );
            pointer-events: none;
            opacity: 0.3;
        }

        .chat-header {
            background: #3a3a3a;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #2c2c2c;
            position: relative;
            z-index: 1;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-back {
            display: none;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .chat-header-info h3 {
            font-size: 15px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 2px;
        }

        .chat-header-info .online-status {
            font-size: 13px;
            color: #31a24c;
            font-weight: 500;
        }

        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-header-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .chat-header-icon img {
            filter: brightness(0) saturate(100%) invert(100%);
        }

        .chat-header-icon:hover {
            background: #4a4a4a;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
            z-index: 1;
            scroll-behavior: auto;
            min-height: 0;
            height: 0;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 65%;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
        }

        .message.received {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.4;
            position: relative;
            padding-bottom: 20px;
        }
        
        .message-bubble.message-bubble-time-only {
            padding: 4px 8px;
            min-width: auto;
            width: auto;
            display: inline-block;
            height: auto;
        }
        
        .message-bubble.message-bubble-time-only .message-time {
            position: relative;
            bottom: auto;
            right: auto;
            display: inline-flex;
        }
        
        .message-emoji {
            font-size: 32px;
            line-height: 1;
            margin: 0 8px 8px 0;
            display: inline-block;
            vertical-align: bottom;
        }

        .message.sent .message-bubble {
            background: #005c4b;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background: #363636;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            position: absolute;
            bottom: 4px;
            right: 8px;
            padding: 0;
            margin: 0;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            pointer-events: none;
            white-space: nowrap;
            flex-wrap: nowrap;
            transform: translateX(11%);
        }

        .message.sent .message-time {
            right: 8px;
        }

        .message.received .message-time {
            right: 8px;
        }

        .message-name {
            font-size: 12px;
            font-weight: 600;
            color: #a1db2d;
            margin-bottom: 4px;
        }

        .message-image {
            margin-bottom: 8px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .message-image img {
            max-width: 300px;
            max-height: 300px;
            width: auto;
            height: auto;
            display: block;
            border-radius: 12px;
        }
        
        .message-image .message-time {
            position: absolute;
            bottom: 4px;
            right: 8px;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Emoji Bar */
        .emoji-bar {
            padding: 8px 20px;
            border-top: 1px solid #2c2c2c;
            border-bottom: 1px solid #2c2c2c;
            overflow-x: auto;
            display: flex;
            gap: 12px;
            position: relative;
            z-index: 1;
            background: #3a3a3a;
            align-items: center;
            min-height: 48px;
        }

        .emoji-item {
            font-size: 32px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 48px;
            width: 48px;
            height: 48px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            flex-shrink: 0;
            user-select: none;
            -webkit-user-select: none;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .emoji-item:hover {
            transform: scale(1.2);
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .emoji-item:active {
            transform: scale(0.9);
            background: rgba(255, 255, 255, 0.2);
        }

        /* Input Area */
        .input-area {
            padding: 12px 20px;
            background: #3a3a3a;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .input-actions-left {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 18px;
            color: #65676b;
        }

        .input-icon:hover {
            background: #4a4a4a;
        }

        .chat-input {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: #2c2c2c;
            color: #ffffff;
            border-radius: 20px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            outline: none;
            max-height: 100px;
            overflow-y: auto;
        }

        .chat-input::placeholder {
            color: #888888;
        }

        .send-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: white;
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 18px;
        }

        .send-icon:hover {
            background: #0066cc;
        }

        .send-icon:disabled {
            background: #c4c4c4;
            cursor: not-allowed;
        }

        /* Image Preview */
        #imagePreview {
            padding: 12px 20px;
            background: #f0f2f5;
            border-top: 1px solid #e5e5e5;
            display: none;
            position: relative;
            z-index: 1;
        }

        .image-preview-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .image-preview-content img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .image-preview-info {
            flex: 1;
        }

        .image-preview-info p {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #1c1e21;
            margin-bottom: 4px;
        }

        .image-preview-info small {
            font-size: 12px;
            color: #65676b;
        }

        .image-preview-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.2s;
        }

        .image-preview-close:hover {
            background: #c82333;
        }

        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            text-align: center;
            padding: 40px;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            opacity: 1;
            color: #ffffff;
        }
        
        .empty-state h3 {
            color: #ffffff;
        }
        
        .empty-state p {
            color: #ffffff;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #65676b;
        }

        .spinner {
            border: 3px solid #f0f2f5;
            border-top: 3px solid #a1db2d;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stats Bar */
        .stats-bar {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden !important;
                overflow-y: hidden !important;
                padding: 0 !important;
                margin: 0 !important;
                padding-bottom: 0 !important;
                margin-bottom: 0 !important;
                height: 100vh !important;
                min-height: 100vh !important;
                max-height: 100vh !important;
            }

            html {
                padding: 0 !important;
                margin: 0 !important;
                padding-bottom: 0 !important;
                margin-bottom: 0 !important;
                height: 100vh !important;
                min-height: 100vh !important;
                max-height: 100vh !important;
            }

            .main-container {
                padding: 0 !important;
                margin: 0 !important;
                padding-bottom: 0 !important;
                margin-bottom: 0 !important;
                height: calc(100vh - 60px) !important;
                min-height: calc(100vh - 60px) !important;
                max-height: calc(100vh - 60px) !important;
                overflow: hidden !important;
            }

            .top-header {
                height: 60px !important;
                display: flex !important;
                padding: 0 10px !important;
                overflow: hidden !important;
            }

            .top-header.hidden {
                display: none !important;
            }

            .header-left {
                gap: 10px !important;
                margin-left: 0 !important;
                flex: 1;
                min-width: 0;
                overflow: hidden;
            }

            .header-logo {
                width: 36px !important;
                height: 36px !important;
                flex-shrink: 0;
            }

            .header-logo img {
                width: 28px !important;
                height: 28px !important;
                margin-left: 0 !important;
                transform: none !important;
            }

            .header-title {
                font-size: 16px !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex: 1;
                min-width: 0;
            }

            .header-title span {
                font-size: 11px !important;
            }

            .header-right {
                gap: 5px !important;
                flex-shrink: 0;
            }

            .header-btn {
                padding: 6px !important;
                min-width: 36px !important;
                width: 36px !important;
                height: 36px !important;
            }

            .header-btn img {
                width: 20px !important;
                height: 20px !important;
            }

            #btnRecargar,
            #btnCerrarSesion {
                padding: 6px !important;
                min-width: 36px !important;
                width: 36px !important;
                height: 36px !important;
            }

            #btnRecargar img,
            #btnCerrarSesion img {
                width: 24px !important;
                height: 24px !important;
            }

            .nav-sidebar {
                display: flex;
                width: 60px;
                border-radius: 0;
                margin: 0;
            }

            .chats-sidebar {
                width: calc(100% - 60px);
                border-radius: 0;
                margin: 0;
            }

            .chat-area.active ~ .chats-sidebar,
            .chat-area.active + .chats-sidebar {
                display: none !important;
            }

            .chat-area.active ~ .nav-sidebar,
            .chat-area.active + .nav-sidebar {
                display: none !important;
            }

            .user-profile {
                padding: 12px 15px !important;
                gap: 10px !important;
            }

            .user-avatar {
                width: 40px !important;
                height: 40px !important;
                font-size: 16px !important;
            }

            .user-name {
                font-size: 14px !important;
            }

            .user-username {
                font-size: 12px !important;
            }

            .user-menu {
                width: 32px !important;
                height: 32px !important;
            }

            .search-container {
                padding: 10px 12px !important;
            }

            .search-input {
                padding: 10px 12px 10px 40px !important;
                font-size: 14px !important;
            }

            .chats-list {
                padding: 6px 0 !important;
            }

            .chat-item {
                padding: 10px 12px !important;
                gap: 10px !important;
            }

            .chat-avatar {
                width: 42px !important;
                height: 42px !important;
                font-size: 15px !important;
            }

            .chat-name {
                font-size: 14px !important;
            }

            .chat-time {
                font-size: 11px !important;
            }

            .chat-preview {
                font-size: 13px !important;
            }

            .chat-status {
                font-size: 11px !important;
            }

            .chat-badge {
                font-size: 11px !important;
                padding: 2px 5px !important;
            }

            .chat-header {
                padding: 10px 15px !important;
                height: auto !important;
                min-height: 50px !important;
            }

            .chat-header-left {
                gap: 10px !important;
            }

            .chat-header-back {
                display: flex !important;
                width: 36px !important;
                height: 36px !important;
                border-radius: 50% !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                margin-right: 8px !important;
                flex-shrink: 0 !important;
            }

            .chat-header-back:hover {
                background: #4a4a4a !important;
            }

            .chat-header-back svg {
                width: 20px !important;
                height: 20px !important;
                fill: #ffffff !important;
            }

            .chat-header-avatar {
                width: 36px !important;
                height: 36px !important;
                font-size: 14px !important;
            }

            .chat-header-info h3 {
                font-size: 15px !important;
            }

            .chat-header-info .online-status {
                font-size: 11px !important;
            }

            .chat-header-icon {
                width: 36px !important;
                height: 36px !important;
            }

            .chat-header-icon img {
                width: 18px !important;
                height: 18px !important;
            }

            .chat-area {
                display: none;
                border-radius: 0;
                margin: 0 !important;
                padding: 0 !important;
                max-height: calc(100vh - 60px) !important;
                height: calc(100vh - 60px) !important;
                min-height: calc(100vh - 60px) !important;
                padding-bottom: 0 !important;
                margin-bottom: 0 !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
                position: fixed !important;
                top: 60px !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
            }

            .chat-area.active {
                display: flex !important;
                flex-direction: column !important;
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                max-height: 100vh !important;
                height: 100vh !important;
                min-height: 100vh !important;
                padding-bottom: 0 !important;
                margin-bottom: 0 !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
            }

            .emoji-bar {
                padding: 6px 12px !important;
                margin: 0 !important;
                margin-bottom: 0 !important;
                padding-bottom: 6px !important;
                min-height: 44px !important;
                max-height: 44px !important;
                height: 44px !important;
                display: none !important; /* Oculto por defecto, se mostrará con JS cuando sea necesario */
                position: relative !important;
                z-index: 1 !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                flex-shrink: 0 !important;
                background: #3a3a3a !important;
                border-top: 1px solid #2c2c2c !important;
                border-bottom: 1px solid #2c2c2c !important;
            }

            .emoji-bar[style*="flex"] {
                display: flex !important;
                height: 44px !important;
                min-height: 44px !important;
                max-height: 44px !important;
            }

            .emoji-item {
                font-size: 28px !important;
                min-width: 40px !important;
                width: 40px !important;
                height: 40px !important;
                border-radius: 10px !important;
                flex-shrink: 0 !important;
            }

            .chat-messages {
                padding: 12px 12px 0 12px !important;
                margin-bottom: 0 !important;
                padding-bottom: 20px !important;
                gap: 8px !important;
                flex: 1 !important;
                min-height: 0 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
            }

            .message {
                max-width: 75% !important;
            }

            .message-bubble {
                padding: 10px 12px !important;
                padding-bottom: 20px !important;
                font-size: 13px !important;
                border-radius: 16px !important;
            }

            .message-time {
                font-size: 10px !important;
                bottom: 4px !important;
            }

            .input-area {
                padding: 8px 12px !important;
                padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px)) !important;
                gap: 6px !important;
                flex-shrink: 0 !important;
                background: #3a3a3a !important;
                border-top: 1px solid #2c2c2c !important;
            }

            .input-actions-left {
                gap: 6px !important;
                flex-shrink: 0 !important;
            }

            .input-icon {
                width: 32px !important;
                height: 32px !important;
                min-width: 32px !important;
                flex-shrink: 0 !important;
            }

            .input-icon img {
                width: 16px !important;
                height: 16px !important;
            }

            .chat-input {
                padding: 10px 12px !important;
                font-size: 14px !important;
                max-height: 100px !important;
                min-height: 36px !important;
                flex: 1 !important;
                min-width: 0 !important;
            }

            .send-icon {
                width: 36px !important;
                height: 36px !important;
                min-width: 36px !important;
                flex-shrink: 0 !important;
                font-size: 16px !important;
            }

            #imagePreview {
                padding: 10px 12px !important;
                padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px)) !important;
                margin-bottom: 0 !important;
                flex-shrink: 0 !important;
                background: #2c2c2c !important;
                border-top: 1px solid #2c2c2c !important;
            }

            .image-preview-content {
                gap: 10px !important;
            }

            .image-preview-content img {
                width: 50px !important;
                height: 50px !important;
            }

            .image-preview-info p {
                font-size: 13px !important;
            }

            .image-preview-info small {
                font-size: 11px !important;
            }

            .image-preview-close {
                width: 28px !important;
                height: 28px !important;
                font-size: 14px !important;
            }

            .stats-area {
                border-radius: 0 !important;
                margin: 0 !important;
                width: calc(100% - 60px);
                height: 100%;
            }

            .stats-header {
                padding: 15px !important;
            }

            .stats-header h2 {
                font-size: 18px !important;
            }

            .stats-content {
                padding: 10px !important;
            }

            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 8px !important;
            }

            .stat-card {
                padding: 10px !important;
                border-radius: 0 !important;
                gap: 8px !important;
                box-shadow: none !important;
            }

            .stat-card:hover {
                transform: none !important;
                box-shadow: none !important;
                background: #4a4a4a !important;
            }

            .stat-card-header {
                gap: 8px !important;
            }

            .stat-icon {
                width: 32px !important;
                height: 32px !important;
                border-radius: 6px !important;
                font-size: 16px !important;
            }

            .stat-info h3 {
                font-size: 11px !important;
                margin: 0 0 3px 0 !important;
            }

            .stat-value {
                font-size: 20px !important;
            }

            .stat-label {
                font-size: 11px !important;
            }

            .stat-progress {
                margin-top: 5px !important;
            }

            .stat-detail {
                font-size: 11px !important;
            }

            .warning-message {
                font-size: 10px !important;
                margin-top: 5px !important;
            }

            .config-area {
                border-radius: 0 !important;
                margin: 0 !important;
                width: calc(100% - 60px);
                height: 100%;
                position: relative;
            }

            .config-header {
                border-radius: 0 !important;
            }

            .config-content {
                border-radius: 0 !important;
            }

            .config-table-container {
                border-radius: 0 !important;
            }

            .config-mobile-overlay {
                padding: 15px !important;
            }

            .config-overlay-content {
                padding: 20px !important;
                max-width: 100% !important;
            }

            .config-overlay-icon {
                font-size: 40px !important;
                margin-bottom: 12px !important;
            }

            .config-overlay-content h3 {
                font-size: 18px !important;
                margin: 0 0 12px 0 !important;
            }

            .config-overlay-content p {
                font-size: 13px !important;
                margin: 0 0 18px 0 !important;
            }

            .config-overlay-close {
                padding: 12px 24px !important;
                font-size: 14px !important;
            }

            .login-section {
                padding: 0 !important;
                min-height: 100vh !important;
            }

            .login-content-area {
                padding: 20px 15px 40px !important;
            }

            .login-section-content {
                max-width: 100% !important;
                padding: 0 !important;
            }

            .login-header {
                padding: 0 !important;
                margin-bottom: 20px !important;
            }

            .login-header h2 {
                font-size: 22px !important;
                white-space: normal !important;
                line-height: 1.2 !important;
                margin: 0 0 12px 0 !important;
            }

            .login-header h2 span {
                font-size: 18px !important;
                display: block !important;
                margin-top: 4px !important;
            }

            .login-header p {
                font-size: 13px !important;
                margin: 0 0 20px 0 !important;
            }

            .login-graphic-image {
                width: 200px !important;
                height: 200px !important;
                top: 8% !important;
                opacity: 0.15 !important;
            }

            .login-input-group {
                margin-bottom: 16px !important;
            }

            .login-input-group input {
                padding: 12px 14px !important;
                font-size: 14px !important;
            }

            .login-options {
                font-size: 12px !important;
                margin-bottom: 20px !important;
                flex-wrap: wrap;
                gap: 10px;
            }

            .login-btn {
                padding: 14px !important;
                font-size: 14px !important;
            }

            .login-error {
                font-size: 12px !important;
                padding: 10px !important;
            }
        }

        /* Scrollbar */
        .chats-list::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chats-list::-webkit-scrollbar-track,
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chats-list::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb {
            background: #c4c4c4;
            border-radius: 3px;
        }

        .chats-list::-webkit-scrollbar-thumb:hover,
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Área de Configuración */
        .config-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #3a3a3a;
            overflow: hidden;
            border-radius: 30px;
            margin: 1%;
            position: relative;
        }

        .config-header {
            background: #3a3a3a;
            padding: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #2c2c2c;
        }

        .config-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }

        .config-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #3a3a3a;
        }

        .config-mobile-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #3a3a3a;
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .config-overlay-content {
            background: #3a3a3a;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .config-overlay-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .config-overlay-content h3 {
            margin: 0 0 15px 0;
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }

        .config-overlay-content p {
            margin: 0 0 20px 0;
            font-size: 14px;
            color: #ffffff;
            line-height: 1.6;
            opacity: 0.9;
        }

        .config-overlay-close {
            background: #0cc71b;
            color: #000000;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .config-overlay-close:hover {
            background: #0aa317;
        }

        /* Área de Estadísticas */
        .stats-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #3a3a3a;
            height: 100%;
            border-radius: 30px;
            margin: 1%;
        }

        .stats-header {
            padding: 20px;
            border-bottom: 1px solid #2c2c2c;
            display: flex;
            align-items: center;
            background: #3a3a3a;
        }

        .stats-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }

        .stats-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #3a3a3a;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #4a4a4a;
            border: 1px solid #2c2c2c;
            border-radius: 12px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background: #505050;
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
        }

        .stat-info {
            flex: 1;
        }

        .stat-info h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 500;
            color: #aaaaaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #ffffff;
            margin: 0;
        }

        .stat-label {
            font-size: 14px;
            color: #aaaaaa;
            margin-top: 4px;
        }

        .stat-progress {
            margin-top: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #2c2c2c;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #a1db2d, #00c853);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 12px;
            color: #aaaaaa;
        }

        .stat-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
        }

        .detail-label {
            font-size: 13px;
            color: #aaaaaa;
            font-weight: 500;
        }

        .detail-value {
            font-size: 14px;
            color: #ffffff;
            font-weight: 600;
        }

        .warning-message {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 10px;
            background: #3a3a3a;
            border: 1px solid #ffc107;
            border-radius: 6px;
            margin-top: 8px;
        }

        .warning-icon {
            font-size: 16px;
            flex-shrink: 0;
        }

        .warning-text {
            font-size: 12px;
            color: #ffc107;
            line-height: 1.4;
        }

        .stats-info {
            background: #4a4a4a;
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
            border: 1px solid #2c2c2c;
        }

        .stats-info h3 {
            margin: 0 0 20px 0;
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 12px;
            color: #aaaaaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }

        .config-loading {
            text-align: center;
            padding: 40px;
            color: #aaaaaa;
        }

        .config-table-container {
            background: #3a3a3a;
        }

        .config-table {
            width: 100%;
            border-collapse: collapse;
            background: #3a3a3a;
            margin-bottom: 20px;
        }

        .config-table th {
            background: #0cc71b;
            color: black;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid #2c2c2c;
        }

        .config-table td {
            padding: 12px;
            border: 1px solid #2c2c2c;
            background: #3a3a3a;
            color: #ffffff;
        }

        .config-table tr:nth-child(even) {
            background: #4a4a4a;
        }

        .config-table tr:nth-child(even) td {
            background: #4a4a4a;
        }

        .config-table tr:hover {
            background: #505050;
        }

        .config-table tr:hover td {
            background: #505050;
        }

        .config-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #2c2c2c;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 40px;
            background: #2c2c2c;
            color: #ffffff;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE y Edge */
        }

        .config-input::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .config-input:focus {
            outline: none;
            border-color: #a1db2d;
            box-shadow: 0 0 0 2px rgba(0, 132, 255, 0.1);
        }

        .config-actions {
            display: flex;
            gap: 8px;
        }

        .config-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .config-btn-delete {
            background: #dc3545;
            color: white;
        }

        .config-btn-delete:hover {
            background: #c82333;
        }

        .add-row-btn {
            padding: 12px 24px;
            background: #0cc71b;
            color: black;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .add-row-btn:hover {
            background: #0066cc;
        }

        /* Modal de notificación */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
            overflow: hidden;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e5e5;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #1c1e21;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #65676b;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #1c1e21;
        }

        .modal-body {
            padding: 24px;
            text-align: center;
        }

        .modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .modal-icon.success {
            color: #42b72a;
        }

        .modal-icon.error {
            color: #dc3545;
        }

        .modal-icon.info {
            color: #a1db2d;
        }

        .modal-body p {
            margin: 0;
            font-size: 16px;
            color: #1c1e21;
            line-height: 1.5;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-btn {
            background: #a1db2d;
            color: black;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn:hover {
            background: #0066cc;
        }

        .modal-btn:active {
            transform: scale(0.98);
        }

        /* Modal de Emojis */
        .emoji-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            animation: fadeIn 0.2s ease;
        }

        .emoji-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .emoji-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e5e5;
        }

        .emoji-modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1c1e21;
        }

        .emoji-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #65676b;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .emoji-modal-close:hover {
            background: #f0f0f0;
            color: #1c1e21;
        }

        .emoji-modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .emoji-category {
            margin-bottom: 20px;
        }

        .emoji-category:last-child {
            margin-bottom: 0;
        }

        .emoji-category-title {
            font-size: 14px;
            font-weight: 600;
            color: #65676b;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .emoji-option {
            font-size: 28px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
        }

        .emoji-option:hover {
            background: #f0f2f5;
            transform: scale(1.1);
        }

        .emoji-option:active {
            transform: scale(0.95);
        }

        /* Estilos de Login */
        .login-section {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100vh;
            background: #1a2126;
            padding: 0;
            position: relative;
            overflow: hidden;
        }

        .login-graphic-area {
            display: none;
        }

        .login-graphic-circle {
            width: 320px;
            height: 320px;
            border-radius: 50%;
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            border: none;
        }

        .login-graphic-circle::before {
            display: none;
        }

        .login-graphic-image {
            width: 320px;
            height: 320px;
            object-fit: contain;
            border-radius: 50%;
            opacity: 0.2;
            display: block;
            visibility: visible;
            position: absolute;
            top: 12.5%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            pointer-events: none;
        }

        .login-content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 30px 60px;
            background: #1a2126;
            position: relative;
            z-index: 2;
        }

        .login-section-content {
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            margin: 0 0 20px 0;
            font-size: 32px;
            font-weight: 300;
            color: #ffffff;
            letter-spacing: -0.5px;
            line-height: 0.9;
        }

        .login-header h2 span {
            display: inline-block;
            margin-top: -15px;
        }

        .login-header p {
            margin: 0 0 20px 0;
            font-size: 14px;
            color: #ffffff;
            line-height: 1.6;
            opacity: 0.9;
        }

        .login-form {
            width: 100%;
        }

        .login-input-group {
            margin-bottom: 20px;
        }

        .login-input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #ffffff;
        }

        .login-input-group input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .login-input-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .login-input-group input:focus {
            outline: none;
            border-color: #0cc71b;
            background: rgba(255, 255, 255, 0.1);
        }

        .login-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            font-size: 13px;
        }

        .login-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
        }

        .login-checkbox input {
            margin-right: 8px;
            cursor: pointer;
        }

        .login-forgot {
            color: #0cc71b;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .login-forgot:hover {
            color: #0aa816;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: #0cc71b;
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .login-btn:hover {
            background: #0aa816;
        }

        .login-btn:active {
            transform: scale(0.98);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            margin-top: 16px;
            padding: 12px;
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid rgba(255, 59, 48, 0.4);
            border-radius: 8px;
            color: #ff6b6b;
            font-size: 14px;
            text-align: center;
        }

        .login-link {
            color: #0cc71b;
            text-decoration: none;
        }

        .login-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Sección de Login -->
    <div id="loginSection" class="login-section" style="display: flex;">
        <div class="login-graphic-area">
            <div class="login-graphic-circle">
                <img src="https://i.imgur.com/wJXPNJf.png" alt="WhatsApp Icons" class="login-graphic-image">
            </div>
        </div>
        <div class="login-content-area">
            <div class="login-section-content">
                <div class="login-header">
                    <h2>Welcome to WhatsApp Bot<br><span style="font-size: 24px; font-family: 'VanillaPancake', sans-serif;">By Codex</span></h2>
                    <p>Inicia sesión con tus credenciales para acceder al panel administrativo.</p>
                </div>
                <img src="https://i.imgur.com/wJXPNJf.png" alt="WhatsApp Icons" class="login-graphic-image">
                <form id="loginForm" class="login-form">
                    <div class="login-input-group">
                        <label for="loginEmail">Correo Electrónico</label>
                        <input type="email" id="loginEmail" placeholder="tu@email.com" required>
                    </div>
                    <div class="login-input-group">
                        <label for="loginPassword">Contraseña</label>
                        <input type="password" id="loginPassword" placeholder="••••••••" required>
                    </div>
                    <div class="login-options">
                        <label class="login-checkbox">
                            <input type="checkbox" id="rememberMe">
                            <span>Recordar sesión</span>
                        </label>
                        <a href="#" class="login-forgot">¿Olvidaste tu contraseña?</a>
                    </div>
                    <button type="submit" class="login-btn">INICIAR SESIÓN</button>
                </form>
                <div id="loginError" class="login-error" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal (oculto hasta login) -->
    <div id="mainContent" style="display: none;">
    <!-- Header Superior -->
    <div class="top-header">
        <div class="header-left">
            <div class="header-logo">
                <img src="images/logo.png" alt="Logo">
            </div>
            <div class="header-title">WhatsApp Bot <span style="font-size: 13.5px; font-family: 'VanillaPancake', sans-serif;">by codex</span></div>
        </div>
        <div class="header-right">
            <button class="header-btn" id="btnRecargar" onclick="cargarChats()">
                <img src="images/recargar.png" alt="Actualizar">
            </button>
            <button class="header-btn" id="btnCerrarSesion" onclick="cerrarSesion()" title="Cerrar Sesión">
                <img src="images/cerrar-sesion.png" alt="Cerrar Sesión">
            </button>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="main-container">
        <!-- Sidebar de Navegación (Izquierda estrecha) -->
        <div class="nav-sidebar">
            <div class="nav-icon active" title="Mensajes" onclick="mostrarVistaMensajes()">
                <img src="images/chat.png" alt="Mensajes" style="width: 24px; height: 24px; object-fit: contain;">
            </div>
            <div class="nav-icon" id="navConfigBot" title="Configuración del Bot" onclick="mostrarVistaConfiguracion()">
                <img src="images/bot.png" alt="Configuración del Bot" style="width: 24px; height: 24px; object-fit: contain;">
            </div>
            <div class="nav-icon" title="Estadísticas" onclick="mostrarVistaEstadisticas()">
                <img src="images/analis.png" alt="Estadísticas" style="width: 24px; height: 24px; object-fit: contain;">
            </div>
            <div class="nav-icon" title="Configuración">
                <img src="images/config.png" alt="Configuración" style="width: 24px; height: 24px; object-fit: contain;">
            </div>
        </div>

        <!-- Sidebar de Chats (Izquierda más ancha) -->
        <div class="chats-sidebar">
            <!-- Perfil del Usuario -->
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Administrador</div>
                    <div class="user-username" id="userEmail">@admin</div>
                </div>
                <div class="user-menu">⋯</div>
            </div>

            <!-- Barra de Búsqueda -->
            <div class="search-container">
                <div class="search-wrapper">
                    <img src="images/lupa.png" alt="Buscar" class="search-icon-absolute">
                    <input type="text" class="search-input" id="searchChats" placeholder="Search">
                </div>
            </div>

            <!-- Lista de Chats -->
            <div class="chats-list" id="chatsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Cargando chats...</p>
                </div>
            </div>
        </div>

        <!-- Área de Estadísticas (oculta por defecto) -->
        <div class="stats-area" id="statsArea" style="display: none;">
            <div class="stats-header">
                <h2>📊 Datos de Uso</h2>
            </div>
            <div class="stats-content">
                <div class="stats-grid">
                    <!-- Tarjeta de Límite Diario -->
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #a1db2d;">📨</div>
                        <div class="stat-info">
                            <h3>Límite Diario</h3>
                            <div class="stat-value">20,000</div>
                            <div class="stat-label">Mensajes</div>
                        </div>
                    </div>

                    <!-- Tarjeta de Agente Humano -->
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #00c853;">👤</div>
                        <div class="stat-info">
                            <h3>Agente Humano</h3>
                            <div class="stat-value" style="color: #00c853;" id="agentesPermitidos">1</div>
                            <div class="stat-label">Agentes permitidos</div>
                        </div>
                        <div class="stat-progress">
                            <div class="stat-detail">
                                <span class="detail-label">Límite de horas:</span>
                                <span class="detail-value" id="limiteHoras">24/7</span>
                            </div>
                            <div class="warning-message">
                                <span class="warning-icon">⚠️</span>
                                <span class="warning-text" id="warningText">Las horas pueden agotarse si otro agente se conecta al mismo usuario</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tarjeta de Mensajes del Mes -->
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #ff9800;">📅</div>
                        <div class="stat-info">
                            <h3>Mensajes del Mes</h3>
                            <div class="stat-value" id="mensajesMes">600,000</div>
                            <div class="stat-label">Total mensual</div>
                        </div>
                    </div>

                    <!-- Tarjeta de Chats Activos -->
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #9c27b0;">💬</div>
                        <div class="stat-info">
                            <h3>Chats Activos</h3>
                            <div class="stat-value" id="chatsActivos">0</div>
                            <div class="stat-label">Conversaciones</div>
                        </div>
                    </div>
                </div>

                <!-- Información Adicional -->
                <div class="stats-info">
                    <h3>Información del Plan</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Plan:</span>
                            <span class="info-value">Premium</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Renovación:</span>
                            <span class="info-value">Automática</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Soporte:</span>
                            <span class="info-value">24/7 Disponible</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Estado:</span>
                            <span class="info-value" style="color: #00c853;">● Activo</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Configuración del Bot (oculta por defecto) -->
        <div class="config-area" id="configArea" style="display: none;">
            <div class="config-mobile-overlay" id="configMobileOverlay">
                <div class="config-overlay-content">
                    <div class="config-overlay-icon">💻</div>
                    <h3>Recomendación</h3>
                    <p>Es recomendable editar la configuración del bot desde una computadora para una mejor experiencia.</p>
                    <button class="config-overlay-close" onclick="cerrarConfigOverlay()">Entendido</button>
                </div>
            </div>
            <div class="config-header">
                <h2>
                    <img src="images/tuerca.svg" alt="Configuración" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                    Configuración del Bot
                </h2>
                <button class="header-btn" onclick="guardarConfiguracion()" style="margin-left: auto;">
                    <img src="images/disk.png" alt="Guardar" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;">
                    Guardar Cambios
                </button>
            </div>
            <div class="config-content">
                <div class="config-loading" id="configLoading">
                    <div class="spinner"></div>
                    <p>Cargando configuración...</p>
                </div>
                <div class="config-table-container" id="configTableContainer" style="display: none;">
                    <table class="config-table">
                        <thead id="configTableHeader">
                            <!-- Las columnas se cargarán dinámicamente desde el Sheet -->
                        </thead>
                        <tbody id="configTableBody">
                        </tbody>
                    </table>
                    <button class="add-row-btn" onclick="agregarFilaConfiguracion()">
                        ➕ Agregar Nueva Fila
                    </button>
                </div>
            </div>
        </div>

        <!-- Área Principal de Chat -->
        <div class="chat-area" id="chatArea">
            <div class="chat-header" id="chatHeader">
                <div class="chat-header-left">
                    <div class="chat-header-avatar" id="chatHeaderAvatar" style="background: #1a3a52; color: #00bfff;">U</div>
                    <div class="chat-header-info">
                        <h3 id="chatHeaderName">Selecciona un chat</h3>
                        <div class="online-status" id="chatHeaderStatus" style="display: none;">Online</div>
                    </div>
                </div>
                <div class="chat-header-right" id="chatHeaderActions" style="display: none;">
                    <div class="chat-header-icon" id="pauseBtn" onclick="togglePausaBot(chatActual)" title="Pausar/Activar Bot">
                        <img src="images/pausa.png" alt="Pausar" id="pauseBtnImg" style="width: 25px; height: 25px; object-fit: contain;">
                    </div>
                    <div class="chat-header-icon">⋯</div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <h3>No hay chat seleccionado</h3>
                    <p>Selecciona un chat de la lista para comenzar</p>
                </div>
            </div>

            <!-- Barra de Emojis -->
            <div class="emoji-bar" id="emojiBar">
                <!-- Los emojis se cargarán dinámicamente -->
            </div>

            <!-- Área de Input -->
            <div class="input-area" id="chatInputArea" style="display: flex;">
                <div class="input-actions-left">
                    <div class="input-icon" onclick="document.getElementById('imageInput').click()" title="Adjuntar">
                        <img src="images/acortar.png" alt="Adjuntar" style="width: 18px; height: 18px; object-fit: contain;">
                    </div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                    <div class="input-icon" id="emojiPickerBtn" onclick="toggleEmojiModal()" title="Emojis">
                        <img src="images/lol.png" alt="Emojis" style="width: 18px; height: 18px; object-fit: contain;">
                    </div>
                </div>
                <textarea class="chat-input" id="messageInput" placeholder="Type something....." rows="1" style="height: auto;"></textarea>
                <div class="send-icon" id="sendBtn" onclick="enviarMensaje()" title="Enviar">➤</div>
            </div>

            <!-- Vista Previa de Imagen -->
            <div id="imagePreview">
                <div class="image-preview-content">
                    <img id="previewImg" src="" alt="Vista previa">
                    <div class="image-preview-info">
                        <p>Imagen seleccionada</p>
                        <small id="imageUrlText"></small>
                    </div>
                    <button class="image-preview-close" onclick="clearImagePreview()">✕</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Form oculto para enviar mensajes -->
    <form id="hiddenForm" method="POST" action="" target="hiddenIframe" style="display: none;">
        <input type="hidden" name="action" id="formAction">
        <input type="hidden" name="to" id="formTo">
        <input type="hidden" name="message" id="formMessage">
        <input type="hidden" name="imageUrl" id="formImageUrl">
    </form>
    <iframe id="hiddenIframe" name="hiddenIframe" style="display: none;"></iframe>

    <!-- Modal de notificación -->
    <div id="notificationModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Notificación</h3>
                <button class="modal-close" onclick="cerrarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalIcon" class="modal-icon"></div>
                <p id="modalMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="cerrarModal()">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Emojis -->
    <div id="emojiModal" class="emoji-modal-overlay" style="display: none;" onclick="if(event.target === this) cerrarEmojiModal()">
        <div class="emoji-modal-content" onclick="event.stopPropagation()">
            <div class="emoji-modal-header">
                <h3>Emojis</h3>
                <button class="emoji-modal-close" onclick="cerrarEmojiModal()">&times;</button>
            </div>
            <div class="emoji-modal-body">
                <div class="emoji-category">
                    <div class="emoji-category-title">Caras</div>
                    <div class="emoji-grid">
                        <span class="emoji-option" onclick="insertarEmoji('😊')">😊</span>
                        <span class="emoji-option" onclick="insertarEmoji('😉')">😉</span>
                        <span class="emoji-option" onclick="insertarEmoji('😂')">😂</span>
                        <span class="emoji-option" onclick="insertarEmoji('😎')">😎</span>
                        <span class="emoji-option" onclick="insertarEmoji('😮')">😮</span>
                        <span class="emoji-option" onclick="insertarEmoji('😢')">😢</span>
                        <span class="emoji-option" onclick="insertarEmoji('😇')">😇</span>
                        <span class="emoji-option" onclick="insertarEmoji('😍')">😍</span>
                        <span class="emoji-option" onclick="insertarEmoji('🤔')">🤔</span>
                        <span class="emoji-option" onclick="insertarEmoji('😴')">😴</span>
                        <span class="emoji-option" onclick="insertarEmoji('😋')">😋</span>
                        <span class="emoji-option" onclick="insertarEmoji('😏')">😏</span>
                        <span class="emoji-option" onclick="insertarEmoji('🙂')">🙂</span>
                        <span class="emoji-option" onclick="insertarEmoji('🙃')">🙃</span>
                        <span class="emoji-option" onclick="insertarEmoji('😅')">😅</span>
                        <span class="emoji-option" onclick="insertarEmoji('🤣')">🤣</span>
                        <span class="emoji-option" onclick="insertarEmoji('😭')">😭</span>
                        <span class="emoji-option" onclick="insertarEmoji('😡')">😡</span>
                        <span class="emoji-option" onclick="insertarEmoji('🤯')">🤯</span>
                        <span class="emoji-option" onclick="insertarEmoji('😱')">😱</span>
                    </div>
                </div>
                <div class="emoji-category">
                    <div class="emoji-category-title">Corazones y Amor</div>
                    <div class="emoji-grid">
                        <span class="emoji-option" onclick="insertarEmoji('❤️')">❤️</span>
                        <span class="emoji-option" onclick="insertarEmoji('💛')">💛</span>
                        <span class="emoji-option" onclick="insertarEmoji('💚')">💚</span>
                        <span class="emoji-option" onclick="insertarEmoji('💙')">💙</span>
                        <span class="emoji-option" onclick="insertarEmoji('💜')">💜</span>
                        <span class="emoji-option" onclick="insertarEmoji('🖤')">🖤</span>
                        <span class="emoji-option" onclick="insertarEmoji('🤍')">🤍</span>
                        <span class="emoji-option" onclick="insertarEmoji('💕')">💕</span>
                        <span class="emoji-option" onclick="insertarEmoji('💖')">💖</span>
                        <span class="emoji-option" onclick="insertarEmoji('💗')">💗</span>
                        <span class="emoji-option" onclick="insertarEmoji('💓')">💓</span>
                        <span class="emoji-option" onclick="insertarEmoji('💝')">💝</span>
                        <span class="emoji-option" onclick="insertarEmoji('💞')">💞</span>
                        <span class="emoji-option" onclick="insertarEmoji('💟')">💟</span>
                        <span class="emoji-option" onclick="insertarEmoji('❣️')">❣️</span>
                        <span class="emoji-option" onclick="insertarEmoji('💘')">💘</span>
                        <span class="emoji-option" onclick="insertarEmoji('💌')">💌</span>
                        <span class="emoji-option" onclick="insertarEmoji('😘')">😘</span>
                        <span class="emoji-option" onclick="insertarEmoji('🥰')">🥰</span>
                        <span class="emoji-option" onclick="insertarEmoji('😍')">😍</span>
                    </div>
                </div>
                <div class="emoji-category">
                    <div class="emoji-category-title">Gestos</div>
                    <div class="emoji-grid">
                        <span class="emoji-option" onclick="insertarEmoji('👋')">👋</span>
                        <span class="emoji-option" onclick="insertarEmoji('👍')">👍</span>
                        <span class="emoji-option" onclick="insertarEmoji('👎')">👎</span>
                        <span class="emoji-option" onclick="insertarEmoji('✌️')">✌️</span>
                        <span class="emoji-option" onclick="insertarEmoji('🤞')">🤞</span>
                        <span class="emoji-option" onclick="insertarEmoji('🤝')">🤝</span>
                        <span class="emoji-option" onclick="insertarEmoji('👏')">👏</span>
                        <span class="emoji-option" onclick="insertarEmoji('🙌')">🙌</span>
                        <span class="emoji-option" onclick="insertarEmoji('🤲')">🤲</span>
                        <span class="emoji-option" onclick="insertarEmoji('🙏')">🙏</span>
                        <span class="emoji-option" onclick="insertarEmoji('✍️')">✍️</span>
                        <span class="emoji-option" onclick="insertarEmoji('💪')">💪</span>
                        <span class="emoji-option" onclick="insertarEmoji('👊')">👊</span>
                        <span class="emoji-option" onclick="insertarEmoji('🤛')">🤛</span>
                        <span class="emoji-option" onclick="insertarEmoji('🤜')">🤜</span>
                        <span class="emoji-option" onclick="insertarEmoji('🤚')">🤚</span>
                        <span class="emoji-option" onclick="insertarEmoji('👌')">👌</span>
                        <span class="emoji-option" onclick="insertarEmoji('🤏')">🤏</span>
                        <span class="emoji-option" onclick="insertarEmoji('👈')">👈</span>
                        <span class="emoji-option" onclick="insertarEmoji('👉')">👉</span>
                    </div>
                </div>
                <div class="emoji-category">
                    <div class="emoji-category-title">Objetos</div>
                    <div class="emoji-grid">
                        <span class="emoji-option" onclick="insertarEmoji('📱')">📱</span>
                        <span class="emoji-option" onclick="insertarEmoji('💻')">💻</span>
                        <span class="emoji-option" onclick="insertarEmoji('⌚')">⌚</span>
                        <span class="emoji-option" onclick="insertarEmoji('📷')">📷</span>
                        <span class="emoji-option" onclick="insertarEmoji('🎥')">🎥</span>
                        <span class="emoji-option" onclick="insertarEmoji('📺')">📺</span>
                        <span class="emoji-option" onclick="insertarEmoji('🔊')">🔊</span>
                        <span class="emoji-option" onclick="insertarEmoji('🎵')">🎵</span>
                        <span class="emoji-option" onclick="insertarEmoji('🎶')">🎶</span>
                        <span class="emoji-option" onclick="insertarEmoji('🎤')">🎤</span>
                        <span class="emoji-option" onclick="insertarEmoji('📚')">📚</span>
                        <span class="emoji-option" onclick="insertarEmoji('📝')">📝</span>
                        <span class="emoji-option" onclick="insertarEmoji('✏️')">✏️</span>
                        <span class="emoji-option" onclick="insertarEmoji('📎')">📎</span>
                        <span class="emoji-option" onclick="insertarEmoji('📌')">📌</span>
                        <span class="emoji-option" onclick="insertarEmoji('📍')">📍</span>
                        <span class="emoji-option" onclick="insertarEmoji('🎁')">🎁</span>
                        <span class="emoji-option" onclick="insertarEmoji('🎉')">🎉</span>
                        <span class="emoji-option" onclick="insertarEmoji('🎊')">🎊</span>
                        <span class="emoji-option" onclick="insertarEmoji('✅')">✅</span>
                    </div>
                </div>
                <div class="emoji-category">
                    <div class="emoji-category-title">Símbolos</div>
                    <div class="emoji-grid">
                        <span class="emoji-option" onclick="insertarEmoji('✅')">✅</span>
                        <span class="emoji-option" onclick="insertarEmoji('❌')">❌</span>
                        <span class="emoji-option" onclick="insertarEmoji('⚠️')">⚠️</span>
                        <span class="emoji-option" onclick="insertarEmoji('❓')">❓</span>
                        <span class="emoji-option" onclick="insertarEmoji('❕')">❕</span>
                        <span class="emoji-option" onclick="insertarEmoji('❗')">❗</span>
                        <span class="emoji-option" onclick="insertarEmoji('💯')">💯</span>
                        <span class="emoji-option" onclick="insertarEmoji('🔥')">🔥</span>
                        <span class="emoji-option" onclick="insertarEmoji('⭐')">⭐</span>
                        <span class="emoji-option" onclick="insertarEmoji('🌟')">🌟</span>
                        <span class="emoji-option" onclick="insertarEmoji('✨')">✨</span>
                        <span class="emoji-option" onclick="insertarEmoji('⚡')">⚡</span>
                        <span class="emoji-option" onclick="insertarEmoji('💡')">💡</span>
                        <span class="emoji-option" onclick="insertarEmoji('🔔')">🔔</span>
                        <span class="emoji-option" onclick="insertarEmoji('🔕')">🔕</span>
                        <span class="emoji-option" onclick="insertarEmoji('🚀')">🚀</span>
                        <span class="emoji-option" onclick="insertarEmoji('🎯')">🎯</span>
                        <span class="emoji-option" onclick="insertarEmoji('🏆')">🏆</span>
                        <span class="emoji-option" onclick="insertarEmoji('🎖️')">🎖️</span>
                        <span class="emoji-option" onclick="insertarEmoji('💎')">💎</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ⚙️ CONFIGURACIÓN - URL del Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxFXmnPoaJwlW6ATPz4LtdSOJy9D7Sxd6GOnBrYRGN5VHXCt_p8VqpdbwhcOwCBCGHdBg/exec';
        
        // 🔧 URL para la sección de configuración del bot
        const CONFIG_URL = 'https://script.google.com/macros/s/AKfycbxlYoY0g_eRBB8SlEp8BS2JmduLEytXYT-R9zbo7iBQ0mmtSqPOzmnxxLGrczrrMNz8/exec';
        
        // 🔐 URL para el sistema de login
        const LOGIN_URL = 'https://script.google.com/macros/s/AKfycbwVVMxBsMI2xdxhd8tXnt7a9zO_0PGDNmmHWsTW_WreFibJcyyz2HFAPDB444aKdgk1Ww/exec';

        // 🔐 FUNCIONES DE LOGIN
        function verificarSesion() {
            const sesion = localStorage.getItem('userSession');
            if (sesion) {
                const sessionData = JSON.parse(sesion);
                // Verificar si la sesión no ha expirado (si tiene fecha de expiración)
                if (sessionData.expires && new Date() > new Date(sessionData.expires)) {
                    localStorage.removeItem('userSession');
                    mostrarLogin();
                } else {
                    ocultarLogin();
                    actualizarPerfilUsuario();
                }
            } else {
                mostrarLogin();
            }
        }

        function mostrarLogin() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }

        function ocultarLogin() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        async function iniciarSesion(email, password, rememberMe) {
            try {
                // Obtener usuarios del Google Sheet
                const response = await fetch(LOGIN_URL);
                const result = await response.json();
                
                if (!result.success) {
                    mostrarErrorLogin('Error al conectar con el servidor. Intenta nuevamente.');
                    return false;
                }
                
                // Buscar el usuario en la lista
                const usuario = result.data.find(u => {
                    const correoMatch = u.correo && u.correo.toString().trim().toLowerCase() === email.toLowerCase();
                    const passwordMatch = u.password && u.password.toString().trim() === password;
                    return correoMatch && passwordMatch;
                });
                
                if (usuario) {
                    const sessionData = {
                        email: email,
                        roll: usuario.roll || '',
                        timestamp: new Date().toISOString()
                    };

                    if (rememberMe) {
                        // Sesión persistente (7 días)
                        sessionData.expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString();
                    } else {
                        // Sesión de sesión (expira al cerrar navegador)
                        sessionData.expires = null;
                    }

                    localStorage.setItem('userSession', JSON.stringify(sessionData));
                    ocultarLogin();
                    actualizarPerfilUsuario();
                    mostrarModal('✅', 'Inicio de sesión exitoso', 'success');
                    return true;
                } else {
                    mostrarErrorLogin('Credenciales incorrectas. Intenta nuevamente.');
                    return false;
                }
            } catch (error) {
                console.error('Error en login:', error);
                mostrarErrorLogin('Error al conectar con el servidor. Verifica tu conexión.');
                return false;
            }
        }

        function actualizarPerfilUsuario() {
            const sesion = localStorage.getItem('userSession');
            if (sesion) {
                try {
                    const sessionData = JSON.parse(sesion);
                    const email = sessionData.email || '';
                    const roll = sessionData.roll || 'Usuario';
                    
                    // Formatear el roll (capitalizar primera letra)
                    let rollFormateado = roll.toLowerCase();
                    rollFormateado = rollFormateado.charAt(0).toUpperCase() + rollFormateado.slice(1);
                    
                    // Si es "admin", mostrar "Administrador"
                    if (rollFormateado.toLowerCase() === 'admin') {
                        rollFormateado = 'Administrador';
                    } else if (rollFormateado.toLowerCase() === 'agente') {
                        rollFormateado = 'Agente';
                    }
                    
                    // Extraer el nombre del email (antes del @)
                    const emailSinArroba = email.split('@')[0] || 'admin';
                    
                    // Actualizar el nombre (roll)
                    const userNameElement = document.getElementById('userName');
                    if (userNameElement) {
                        userNameElement.textContent = rollFormateado;
                    }
                    
                    // Actualizar el email
                    const userEmailElement = document.getElementById('userEmail');
                    if (userEmailElement) {
                        userEmailElement.textContent = '@' + emailSinArroba;
                    }
                    
                    // Actualizar el avatar con la primera letra del roll o imagen si es administrador
                    const userAvatarElement = document.getElementById('userAvatar');
                    if (userAvatarElement) {
                        const rollLower = rollFormateado.toLowerCase();
                        if (rollLower === 'administrador' || rollLower === 'admin') {
                            // Si es administrador, mostrar la imagen admin.png con fondo blanco y insignia de verificado
                            userAvatarElement.innerHTML = '<img src="images/admin.png" alt="Admin" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"><div class="verified-badge"><img src="images/verificar.png" alt="Verificado"></div>';
                            userAvatarElement.style.background = '#ffffff';
                        } else {
                            // Si no es administrador, mostrar la letra con fondo verde
                            userAvatarElement.textContent = rollFormateado.charAt(0).toUpperCase();
                            userAvatarElement.style.background = '#a1db2d';
                        }
                    }
                    
                    // Controlar visibilidad del icono de configuración del bot
                    actualizarPermisosNavegacion(roll);
                } catch (error) {
                    console.error('Error al actualizar perfil:', error);
                }
            }
        }

        function actualizarPermisosNavegacion(roll) {
            const navConfigBot = document.getElementById('navConfigBot');
            if (navConfigBot) {
                // Solo administradores pueden ver la configuración del bot
                const rollLower = roll ? roll.toLowerCase().trim() : '';
                if (rollLower === 'admin' || rollLower === 'administrador') {
                    navConfigBot.style.display = 'flex';
                } else {
                    navConfigBot.style.display = 'none';
                }
            }
        }

        function cerrarSesion() {
            localStorage.removeItem('userSession');
            mostrarLogin();
            mostrarModal('👋', 'Sesión cerrada correctamente', 'info');
        }

        function mostrarErrorLogin(mensaje) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = mensaje;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Inicializar verificación de sesión al cargar
        document.addEventListener('DOMContentLoaded', function() {
            verificarSesion();

            // Manejar el formulario de login
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    const rememberMe = document.getElementById('rememberMe').checked;
                    
                    const loginBtn = loginForm.querySelector('.login-btn');
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'Iniciando sesión...';

                    try {
                        const success = await iniciarSesion(email, password, rememberMe);
                        if (success) {
                            loginForm.reset();
                        }
                    } catch (error) {
                        console.error('Error en el formulario de login:', error);
                        mostrarErrorLogin('Error al procesar el login. Intenta nuevamente.');
                    } finally {
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Iniciar Sesión';
                    }
                });
            }
        });

        let chats = [];
        let chatActual = null;
        let intervaloActualizacion = null;
        let ultimoMensajeId = {};
        window.chatsPausados = {};
        let configOriginal = []; // Almacena la configuración original para comparar cambios

        // Funciones para el modal
        function mostrarModal(titulo, mensaje, tipo = 'success') {
            const modal = document.getElementById('notificationModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalIcon = document.getElementById('modalIcon');
            
            modalTitle.textContent = titulo;
            modalMessage.textContent = mensaje;
            
            // Limpiar clases anteriores
            modalIcon.className = 'modal-icon';
            
            // Agregar icono según el tipo
            if (tipo === 'success') {
                modalIcon.className += ' success';
                modalIcon.textContent = '✅';
            } else if (tipo === 'error') {
                modalIcon.className += ' error';
                modalIcon.textContent = '❌';
            } else {
                modalIcon.className += ' info';
                modalIcon.textContent = 'ℹ️';
            }
            
            modal.style.display = 'flex';
        }

        function cerrarModal() {
            const modal = document.getElementById('notificationModal');
            modal.style.display = 'none';
        }

        // Funciones para el modal de emojis
        function toggleEmojiModal() {
            const modal = document.getElementById('emojiModal');
            if (modal.style.display === 'none' || !modal.style.display) {
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }

        function cerrarEmojiModal() {
            const modal = document.getElementById('emojiModal');
            modal.style.display = 'none';
        }

        // Funciones para gestionar los últimos emojis usados
        function guardarEmojiUsado(emoji) {
            let ultimosEmojis = JSON.parse(localStorage.getItem('ultimosEmojis') || '[]');
            // Remover el emoji si ya existe
            ultimosEmojis = ultimosEmojis.filter(e => e !== emoji);
            // Agregar al inicio
            ultimosEmojis.unshift(emoji);
            // Limitar a 8 emojis
            ultimosEmojis = ultimosEmojis.slice(0, 8);
            // Guardar
            localStorage.setItem('ultimosEmojis', JSON.stringify(ultimosEmojis));
            // Actualizar la barra
            actualizarBarraEmojis();
        }

        function obtenerUltimosEmojis() {
            const ultimosEmojis = JSON.parse(localStorage.getItem('ultimosEmojis') || '[]');
            // Si no hay emojis guardados, usar los emojis por defecto
            if (ultimosEmojis.length === 0) {
                return ['😊', '😉', '😂', '😎', '❤️', '😮', '😢', '😇'];
            }
            return ultimosEmojis;
        }

        function actualizarBarraEmojis() {
            const emojiBar = document.getElementById('emojiBar');
            if (!emojiBar) return;
            
            const ultimosEmojis = obtenerUltimosEmojis();
            emojiBar.innerHTML = '';
            
            ultimosEmojis.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.title = emoji; // Tooltip con el emoji
                emojiItem.addEventListener('click', function() {
                    insertarEmoji(emoji);
                });
                emojiItem.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    this.style.transform = 'scale(0.95)';
                });
                emojiItem.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.style.transform = '';
                    insertarEmoji(emoji);
                });
                emojiBar.appendChild(emojiItem);
            });
            
            // Mostrar barra de emojis solo si hay un chat seleccionado
            const chatHeaderName = document.getElementById('chatHeaderName');
            const hasChatSelected = chatHeaderName && chatHeaderName.textContent !== 'Selecciona un chat' && chatHeaderName.textContent.trim() !== '';
            
            if (window.innerWidth <= 768) {
                const inputArea = document.getElementById('chatInputArea');
                if (inputArea && hasChatSelected && (inputArea.style.display === 'flex' || inputArea.style.display === '')) {
                    emojiBar.style.display = 'flex';
                } else {
                    emojiBar.style.display = 'none';
                }
            } else {
                // En desktop también ocultar si no hay chat
                if (!hasChatSelected) {
                    emojiBar.style.display = 'none';
                }
            }
        }

        function insertarEmoji(emoji) {
            const messageInput = document.getElementById('messageInput');
            const cursorPos = messageInput.selectionStart;
            const textBefore = messageInput.value.substring(0, cursorPos);
            const textAfter = messageInput.value.substring(messageInput.selectionEnd);
            messageInput.value = textBefore + emoji + textAfter;
            
            // Restaurar posición del cursor después del emoji
            messageInput.selectionStart = messageInput.selectionEnd = cursorPos + emoji.length;
            
            // Enfocar el input
            messageInput.focus();
            
            // Auto-resize del textarea
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
            
            // Guardar el emoji usado
            guardarEmojiUsado(emoji);
            
            // Cerrar el modal después de insertar (si está abierto)
            const emojiModal = document.getElementById('emojiModal');
            if (emojiModal && emojiModal.style.display !== 'none') {
                cerrarEmojiModal();
            }
        }

        // Cerrar modal al hacer clic fuera
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('notificationModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        cerrarModal();
                    }
                });
            }
        });

        // Cargar chats al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            cargarPausas();
            cargarChats();
            
            // Auto-actualizar cada 5 segundos
            intervaloActualizacion = setInterval(() => {
                if (chatActual) {
                    cargarMensajes(chatActual, true);
                }
                cargarChats();
            }, 5000);

            // Búsqueda de chats
            document.getElementById('searchChats').addEventListener('input', filtrarChats);

            // Auto-resize del textarea
            document.getElementById('messageInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });

            // Enviar con Enter
            document.getElementById('messageInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    enviarMensaje();
                }
            });

            // Regresar con ESC en móvil
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' || e.key === 'Esc') {
                    const chatArea = document.getElementById('chatArea');
                    const isMobile = window.innerWidth <= 768;
                    
                    // Solo en móvil y si el chat está activo
                    if (isMobile && chatArea && chatArea.classList.contains('active')) {
                        mostrarVistaMensajes();
                    }
                }
            });

            // Cargar la barra de emojis con los últimos usados
            actualizarBarraEmojis();
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatearTiempo(timestamp) {
            if (!timestamp) return '';
            
            try {
                const fecha = new Date(timestamp);
                
                // Formatear la hora en formato 12 horas con AM/PM en español
                const horas = fecha.getHours();
                const minutos = fecha.getMinutes();
                const periodo = horas >= 12 ? 'p. m.' : 'a. m.';
                const horas12 = horas % 12 || 12;
                const minutosStr = minutos.toString().padStart(2, '0');
                
                return `${horas12}:${minutosStr} ${periodo}`;
            } catch (e) {
                return '';
            }
        }

        function getInitials(name) {
            if (!name) return 'U';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        function getRandomColor(phone) {
            // Generar un hash del teléfono para obtener un color consistente
            let hash = 0;
            const phoneStr = String(phone || '');
            for (let i = 0; i < phoneStr.length; i++) {
                hash = phoneStr.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            // Generar un color HSL con saturación y luminosidad fijas para colores vibrantes
            const hue = Math.abs(hash) % 360;
            // Usar colores vibrantes con buena saturación y luminosidad
            const saturation = 60 + (Math.abs(hash) % 30); // 60-90%
            const lightness = 45 + (Math.abs(hash) % 15); // 45-60%
            
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        function cargarPausas() {
            fetch(SCRIPT_URL + '?action=getPausas')
                .then(response => response.text())
                .then(text => {
                    try {
                        const data = JSON.parse(text);
                        window.chatsPausados = data.pausas || {};
                    } catch (e) {
                        window.chatsPausados = {};
                    }
                })
                .catch(err => {
                    console.error('Error al cargar pausas:', err);
                    window.chatsPausados = {};
                });
        }

        // Funciones para guardar/cargar chats desde localStorage
        function guardarChatsEnLocalStorage(chatsData) {
            try {
                localStorage.setItem('chatsFallback', JSON.stringify({
                    chats: chatsData,
                    timestamp: new Date().toISOString()
                }));
            } catch (error) {
                console.error('Error al guardar chats en localStorage:', error);
            }
        }

        function cargarChatsDesdeLocalStorage() {
            try {
                const stored = localStorage.getItem('chatsFallback');
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data.chats && Array.isArray(data.chats)) {
                        return data.chats;
                    }
                }
            } catch (error) {
                console.error('Error al cargar chats desde localStorage:', error);
            }
            return null;
        }

        function actualizarChatsSilenciosamente(chatsNuevos) {
            // Comparar chats nuevos con los actuales y actualizar solo lo necesario
            const chatsNuevosMap = new Map();
            chatsNuevos.forEach(chat => {
                const key = chat.phone?.toString() || '';
                chatsNuevosMap.set(key, chat);
            });

            // Actualizar chats existentes y agregar nuevos
            let huboCambios = false;
            chatsNuevos.forEach(chatNuevo => {
                const key = chatNuevo.phone?.toString() || '';
                const chatExistente = chats.find(c => (c.phone?.toString() || '') === key);
                
                if (!chatExistente) {
                    // Chat nuevo
                    chats.push(chatNuevo);
                    huboCambios = true;
                } else {
                    // Verificar si hay cambios en mensajes
                    const mensajesNuevos = chatNuevo.messages || [];
                    const mensajesExistentes = chatExistente.messages || [];
                    const ultimoMensajeNuevo = mensajesNuevos[mensajesNuevos.length - 1];
                    const ultimoMensajeExistente = mensajesExistentes[mensajesExistentes.length - 1];
                    
                    if (ultimoMensajeNuevo && (!ultimoMensajeExistente || ultimoMensajeNuevo.id !== ultimoMensajeExistente.id)) {
                        // Hay mensajes nuevos
                        chatExistente.messages = mensajesNuevos;
                        huboCambios = true;
                    }
                }
            });

            return huboCambios;
        }

        function cargarChats() {
            // Cargar primero desde localStorage como fallback
            const chatsFallback = cargarChatsDesdeLocalStorage();
            if (chatsFallback && chatsFallback.length > 0) {
                chats = chatsFallback;
                mostrarChats();
                
                // Actualizar stats desde fallback
                const totalChatsEl = document.getElementById('totalChats');
                const totalMensajesEl = document.getElementById('totalMensajes');
                if (totalChatsEl) {
                    totalChatsEl.textContent = chats.length;
                }
                if (totalMensajesEl) {
                    const totalMensajes = chats.reduce((sum, chat) => sum + (chat.messages?.length || 0), 0);
                    totalMensajesEl.textContent = totalMensajes;
                }
            }

            // Luego actualizar silenciosamente desde el servidor
            fetch(SCRIPT_URL + '?action=getChats')
                .then(response => response.text())
                .then(text => {
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        if (text.trim() === 'OK' || text.trim() === '') {
                            data = { chats: [] };
                        } else {
                            throw new Error('Respuesta no válida');
                        }
                    }

                    if (data.chats && Array.isArray(data.chats)) {
                        // Actualizar silenciosamente sin recargar toda la interfaz
                        const huboCambios = actualizarChatsSilenciosamente(data.chats);
                        
                        // Guardar en localStorage
                        guardarChatsEnLocalStorage(data.chats);
                        
                        // Solo actualizar la interfaz si hay cambios
                        if (huboCambios || !chatsFallback) {
                        mostrarChats();
                        
                            // Actualizar stats
                        const totalChatsEl = document.getElementById('totalChats');
                        const totalMensajesEl = document.getElementById('totalMensajes');
                        if (totalChatsEl) {
                            totalChatsEl.textContent = chats.length;
                        }
                        if (totalMensajesEl) {
                            const totalMensajes = chats.reduce((sum, chat) => sum + (chat.messages?.length || 0), 0);
                            totalMensajesEl.textContent = totalMensajes;
                            }
                        }
                        
                        // Actualizar estadísticas si la sección está visible
                        if (document.getElementById('statsArea') && document.getElementById('statsArea').style.display === 'flex') {
                            cargarEstadisticas();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error al cargar chats:', error);
                    // Si hay error y no hay fallback, mostrar error
                    if (!chatsFallback || chats.length === 0) {
                    document.getElementById('chatsList').innerHTML = `
                        <div class="loading">
                            <p>Error al cargar chats</p>
                        </div>
                    `;
                    }
                });
        }

        function mostrarChats() {
            const container = document.getElementById('chatsList');
            const searchTerm = (document.getElementById('searchChats').value || '').toLowerCase();

            if (chats.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No hay chats disponibles</p>
                    </div>
                `;
                return;
            }

            const filteredChats = chats.filter(chat => {
                const phoneStr = (chat.phone || '').toString().toLowerCase();
                const nameStr = (chat.name || '').toLowerCase();
                return phoneStr.includes(searchTerm) || nameStr.includes(searchTerm);
            });

            container.innerHTML = filteredChats.map(chat => {
                const phoneStr = (chat.phone || '').toString();
                let nombre = phoneStr; // Por defecto usar el número
                
                // Buscar el nombre del cliente desde los mensajes recibidos (igual que en message-name)
                if (chat.messages && Array.isArray(chat.messages)) {
                    // Buscar el primer mensaje del cliente (no enviado por el bot) que tenga nombre
                    // Usar la misma lógica que en crearMensajeHTML
                    for (let msg of chat.messages) {
                        const tieneFrom = msg.from && msg.from !== '';
                        const tieneTo = msg.to && msg.to !== '';
                        const esEnviado = msg.from === 'YO' || msg.from === 'Yo' || msg.status === 'sent' || (tieneTo && !tieneFrom) || (tieneTo && msg.from !== phoneStr);
                        
                        // Si NO es enviado (es del cliente) y tiene nombre
                        if (!esEnviado && msg.name && String(msg.name).trim() !== '' && String(msg.name).trim() !== 'Bot') {
                            nombre = String(msg.name).trim();
                            break; // Usar el primer nombre encontrado (o el más reciente si ordenamos)
                        }
                    }
                    
                    // Si aún no encontramos nombre, buscar en orden inverso (más reciente primero)
                    if (nombre === phoneStr) {
                        const mensajesOrdenados = [...chat.messages].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        for (let msg of mensajesOrdenados) {
                            const tieneFrom = msg.from && msg.from !== '';
                            const tieneTo = msg.to && msg.to !== '';
                            const esEnviado = msg.from === 'YO' || msg.from === 'Yo' || msg.status === 'sent' || (tieneTo && !tieneFrom) || (tieneTo && msg.from !== phoneStr);
                            
                            if (!esEnviado && msg.name && String(msg.name).trim() !== '' && String(msg.name).trim() !== 'Bot' && String(msg.name).trim() !== phoneStr) {
                                nombre = String(msg.name).trim();
                                break;
                            }
                        }
                    }
                }
                
                // Si aún no hay nombre, usar el del chat (si existe y no es el número)
                if (nombre === phoneStr && chat.name && chat.name !== phoneStr && chat.name !== 'Bot') {
                    nombre = chat.name;
                }
                
                const preview = (chat.lastMessage?.body || '').substring(0, 50);
                const tiempo = formatearTiempo(chat.lastMessage?.received_at || chat.lastMessage?.timestamp);
                const isActive = chatActual && chatActual.toString() === phoneStr;
                const initials = getInitials(nombre);
                const unreadCount = chat.unreadCount || 0;
                const isPausado = window.chatsPausados && window.chatsPausados[phoneStr];
                const avatarColor = getRandomColor(phoneStr);

                return `
                    <div class="chat-item ${isActive ? 'active' : ''}" onclick="seleccionarChat('${phoneStr}')">
                        <div class="chat-avatar" style="background: ${avatarColor};">${initials}</div>
                        <div class="chat-content">
                            <div class="chat-top">
                                <span class="chat-name">${escapeHtml(nombre)}</span>
                                <span class="chat-time">${tiempo}</span>
                            </div>
                            <div class="chat-bottom">
                                <span class="chat-preview">${escapeHtml(preview)}</span>
                                ${unreadCount > 0 ? `<span class="chat-badge">${unreadCount}</span>` : ''}
                                ${isPausado ? '<img src="images/pausa.png" alt="Pausado" style="width: 16px; height: 16px; object-fit: contain; vertical-align: middle;">' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filtrarChats() {
            mostrarChats();
        }

        function seleccionarChat(phone) {
            // Cerrar todas las secciones y mostrar solo el chat
            const chatArea = document.getElementById('chatArea');
            const chatsSidebar = document.querySelector('.chats-sidebar');
            const navSidebar = document.querySelector('.nav-sidebar');
            const isMobile = window.innerWidth <= 768;
            
            // En móvil: ocultar sidebar y nav-sidebar, mostrar chat con clase active
            if (isMobile) {
                if (chatsSidebar) {
                    chatsSidebar.style.display = 'none';
                }
                if (navSidebar) {
                    navSidebar.style.display = 'none';
                }
                chatArea.classList.add('active');
                chatArea.style.display = 'flex';
            } else {
                // En desktop: comportamiento normal
                chatArea.style.display = 'flex';
            }
            
            // Ocultar el top-header cuando se entra a un chat
            const topHeader = document.querySelector('.top-header');
            if (topHeader) {
                topHeader.classList.add('hidden');
            }
            
            document.getElementById('configArea').style.display = 'none';
            document.getElementById('statsArea').style.display = 'none';
            
            // Actualizar iconos activos - activar el icono de Mensajes
            document.querySelectorAll('.nav-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            document.querySelectorAll('.nav-icon')[0].classList.add('active');
            chatActual = phone.toString();
            ultimoMensajeId[chatActual] = null;
            cargarMensajes(chatActual);
            mostrarChats();
        }

        function cargarMensajes(phone, silencioso = false) {
            const phoneStr = phone.toString();
            const chat = chats.find(c => c.phone && c.phone.toString() === phoneStr);

            if (!chat && !silencioso) {
                document.getElementById('chatHeaderName').textContent = phoneStr;
                document.getElementById('chatHeaderStatus').style.display = 'none';
                document.getElementById('chatHeaderActions').style.display = 'none';
                const headerAvatar = document.getElementById('chatHeaderAvatar');
                headerAvatar.textContent = 'Usuario';
                headerAvatar.style.background = '#1a3a52';
                headerAvatar.style.color = '#00bfff';
                // Mantener el input area siempre visible
                // document.getElementById('chatInputArea').style.display = 'none';
                document.getElementById('emojiBar').style.display = 'none';
            } else if (!silencioso) {
                // Obtener el nombre del cliente usando la misma lógica que en mostrarChats
                let nombre = phoneStr; // Por defecto usar el número
                
                // Buscar el nombre del cliente desde los mensajes recibidos (igual que en message-name)
                if (chat.messages && Array.isArray(chat.messages)) {
                    // Buscar el primer mensaje del cliente (no enviado por el bot) que tenga nombre
                    // Usar la misma lógica que en crearMensajeHTML
                    for (let msg of chat.messages) {
                        const tieneFrom = msg.from && msg.from !== '';
                        const tieneTo = msg.to && msg.to !== '';
                        const esEnviado = msg.from === 'YO' || msg.from === 'Yo' || msg.status === 'sent' || (tieneTo && !tieneFrom) || (tieneTo && msg.from !== phoneStr);
                        
                        // Si NO es enviado (es del cliente) y tiene nombre
                        if (!esEnviado && msg.name && String(msg.name).trim() !== '' && String(msg.name).trim() !== 'Bot') {
                            nombre = String(msg.name).trim();
                            break; // Usar el primer nombre encontrado
                        }
                    }
                    
                    // Si aún no encontramos nombre, buscar en orden inverso (más reciente primero)
                    if (nombre === phoneStr) {
                        const mensajesOrdenados = [...chat.messages].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        for (let msg of mensajesOrdenados) {
                            const tieneFrom = msg.from && msg.from !== '';
                            const tieneTo = msg.to && msg.to !== '';
                            const esEnviado = msg.from === 'YO' || msg.from === 'Yo' || msg.status === 'sent' || (tieneTo && !tieneFrom) || (tieneTo && msg.from !== phoneStr);
                            
                            if (!esEnviado && msg.name && String(msg.name).trim() !== '' && String(msg.name).trim() !== 'Bot' && String(msg.name).trim() !== phoneStr) {
                                nombre = String(msg.name).trim();
                                break;
                            }
                        }
                    }
                }
                
                // Si aún no hay nombre, usar el del chat (si existe y no es el número)
                if (nombre === phoneStr && chat.name && chat.name !== phoneStr && chat.name !== 'Bot') {
                    nombre = chat.name;
                }
                
                const initials = getInitials(nombre);
                const botPausado = window.chatsPausados && window.chatsPausados[phoneStr];
                const headerAvatarColor = getRandomColor(phoneStr);

                document.getElementById('chatHeaderName').textContent = nombre;
                document.getElementById('chatHeaderStatus').textContent = 'Online';
                document.getElementById('chatHeaderStatus').style.display = 'block';
                const headerAvatar = document.getElementById('chatHeaderAvatar');
                headerAvatar.textContent = initials;
                headerAvatar.style.background = headerAvatarColor;
                headerAvatar.style.color = '';
                document.getElementById('chatHeaderActions').style.display = 'flex';
                const pauseBtnImg = document.getElementById('pauseBtnImg');
                if (pauseBtnImg) {
                    pauseBtnImg.src = botPausado ? 'images/play.png' : 'images/pausa.png';
                }
                // El input area ahora está siempre visible
                // document.getElementById('chatInputArea').style.display = 'flex';
                // Mostrar barra de emojis solo en móvil cuando hay un chat válido
                if (window.innerWidth <= 768) {
                    document.getElementById('emojiBar').style.display = 'flex';
                }
            }

            fetch(SCRIPT_URL + '?action=getMessages')
                .then(response => response.text())
                .then(text => {
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        if (text.trim() === 'OK' || text.trim() === '') {
                            if (!silencioso) mostrarMensajes([]);
                            return;
                        }
                        throw new Error('Respuesta no válida');
                    }

                    if (data.messages && Array.isArray(data.messages)) {
                        const phoneNormalized = phoneStr;
                        const mensajesChat = data.messages.filter(msg => {
                            if (!msg) return false;
                            const msgFrom = (msg.from || '').toString();
                            const msgTo = (msg.to || '').toString();
                            const esRecibido = msgFrom === phoneNormalized;
                            const esEnviado = (msgFrom === 'YO' && msgTo === phoneNormalized) || (msgTo === phoneNormalized);
                            return esRecibido || esEnviado;
                        });

                        // Ordenar mensajes: más antiguos primero (para mostrar más recientes abajo)
                        mensajesChat.sort((a, b) => {
                            const aTime = new Date(a.received_at || (typeof a.timestamp === 'number' && a.timestamp < 10000000000 ? a.timestamp * 1000 : a.timestamp) || 0).getTime();
                            const bTime = new Date(b.received_at || (typeof b.timestamp === 'number' && b.timestamp < 10000000000 ? b.timestamp * 1000 : b.timestamp) || 0).getTime();
                            return aTime - bTime; // Orden ascendente: más antiguos primero
                        });

                        const nuevoUltimoId = mensajesChat.length > 0 ? mensajesChat[mensajesChat.length - 1].id : null;
                        const hayNuevosMensajes = nuevoUltimoId !== ultimoMensajeId[chatActual];
                        
                        if (hayNuevosMensajes || !silencioso) {
                            ultimoMensajeId[chatActual] = nuevoUltimoId;
                            mostrarMensajes(mensajesChat, hayNuevosMensajes);
                        }
                    } else if (!silencioso) {
                        mostrarMensajes([]);
                    }
                })
                .catch(error => {
                    if (!silencioso) {
                        console.error('Error completo:', error);
                        document.getElementById('chatMessages').innerHTML = `
                            <div class="empty-state">
                                <p>Error al cargar mensajes: ${error.message}</p>
                            </div>
                        `;
                    }
                });
        }

        function mostrarMensajes(mensajes, hacerScroll = true) {
            const container = document.getElementById('chatMessages');

            // NO remover mensajes temporales - se actualizarán silenciosamente si coinciden

            if (!mensajes || mensajes.length === 0) {
                // Solo mostrar empty-state si no hay mensajes y el contenedor está vacío
                if (container.children.length === 0 || container.querySelector('.empty-state')) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        <h3>No hay mensajes</h3>
                        <p>Inicia la conversación enviando un mensaje</p>
                    </div>
                `;
                }
                return;
            }

            const mensajesValidos = mensajes.filter(msg => msg && typeof msg === 'object' && (msg.body || msg.text || msg.type));

            if (mensajesValidos.length === 0) {
                if (container.children.length === 0 || container.querySelector('.empty-state')) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No hay mensajes válidos</h3>
                    </div>
                `;
                }
                return;
            }

            // Obtener IDs de mensajes ya mostrados (reales y temporales)
            const mensajesExistentes = Array.from(container.querySelectorAll('.message[data-msg-id]'))
                .map(el => {
                    const id = el.getAttribute('data-msg-id');
                    const bubble = el.querySelector('.message-bubble');
                    const img = el.querySelector('.message-image img');
                    const content = bubble ? bubble.textContent.trim() : (img ? 'IMAGE' : '');
                    return {
                        id: id,
                        isTemp: id && id.startsWith('temp-'),
                        content: content,
                        contentLower: content.toLowerCase(),
                        element: el
                    };
                });

            // Obtener solo IDs reales (no temporales)
            const idsReales = mensajesExistentes
                .filter(m => !m.isTemp)
                .map(m => m.id);

            // Filtrar mensajes nuevos que no están ya mostrados como reales
            const mensajesNuevos = mensajesValidos.filter(msg => {
                const msgId = msg.id || msg.timestamp || '';
                return msgId && !idsReales.includes(msgId.toString());
            });

            // Para mensajes enviados por YO, intentar actualizar el temporal en lugar de crear nuevo
            const mensajesParaAgregar = [];
            const mensajesTemporales = mensajesExistentes.filter(m => m.isTemp);

            mensajesNuevos.forEach(msg => {
                const esEnviado = msg.from === 'YO' || msg.from === 'Yo' || msg.status === 'sent';
                if (esEnviado) {
                    // Buscar mensaje temporal que coincida con este mensaje real
                    let msgBody = '';
                    if (msg.body) {
                        msgBody = msg.body.toString().trim();
                    } else if (msg.text && typeof msg.text === 'object' && msg.text.body) {
                        msgBody = msg.text.body.toString().trim();
                    } else if (msg.text && typeof msg.text === 'string') {
                        msgBody = msg.text.toString().trim();
                    }
                    
                    const msgBodyLower = msgBody.toLowerCase();
                    const msgImage = msg.type === 'image' && msg.media_url;
                    
                    let encontrado = false;
                    for (let tempMsg of mensajesTemporales) {
                        // Comparar contenido de forma más flexible
                        const coincideTexto = msgBody !== '' && (
                            tempMsg.content === msgBody || 
                            tempMsg.contentLower === msgBodyLower ||
                            tempMsg.content.includes(msgBody) ||
                            msgBody.includes(tempMsg.content)
                        );
                        const coincideImagen = msgImage && tempMsg.content === 'IMAGE';
                        
                        if (coincideTexto || coincideImagen) {
                            // Solo actualizar el ID del mensaje temporal, sin cambiar NADA visual
                            // El mensaje ya está mostrado correctamente, no necesita actualización visual
                            const tempElement = tempMsg.element;
                            const msgId = msg.id || msg.timestamp || '';
                            
                            // Actualizar solo el data-msg-id silenciosamente sin tocar el DOM visual
                            if (tempElement.getAttribute('data-msg-id') !== msgId.toString()) {
                                tempElement.setAttribute('data-msg-id', msgId.toString());
                            }
                            
                            // NO actualizar el timestamp, NO actualizar nada visual
                            // El mensaje temporal permanece exactamente igual visualmente
                            // El timestamp real se mostrará cuando se recargue la página o el chat
                            
                            encontrado = true;
                            break;
                        }
                    }
                    
                    if (!encontrado) {
                        mensajesParaAgregar.push(msg);
                    }
                } else {
                    // Mensajes recibidos siempre se agregan
                    mensajesParaAgregar.push(msg);
                }
            });

            // Si no hay mensajes nuevos y ya hay mensajes mostrados, no hacer nada
            if (mensajesParaAgregar.length === 0 && idsReales.length > 0) {
                // Remover mensajes temporales que ya no tienen correspondencia (por si acaso)
                mensajesTemporales.forEach(tempMsg => {
                    // Si el mensaje temporal no fue actualizado, mantenerlo
                    // (puede ser que aún no llegue del servidor)
                });
                return;
            }

            // Si hay mensajes nuevos para agregar, agregarlos
            if (mensajesParaAgregar.length > 0) {
                // Remover empty-state si existe
                const emptyState = container.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }

                // Agregar solo los mensajes nuevos que no pudieron ser actualizados
                mensajesParaAgregar.forEach((msg, index) => {
                    const mensajeHtml = crearMensajeHTML(msg, index);
                    container.insertAdjacentHTML('beforeend', mensajeHtml);
                });

                // Scroll instantáneo al final (sin animación)
                if (hacerScroll) {
                    container.scrollTop = container.scrollHeight;
                }
            } else if (mensajesExistentes.length === 0) {
                // Si no hay mensajes existentes, mostrar todos (primera carga)
            container.innerHTML = mensajesValidos.map((msg, index) => {
                    return crearMensajeHTML(msg, index);
                }).join('');

                // Scroll instantáneo al final (sin animación)
                container.scrollTop = container.scrollHeight;
            }
        }

        function crearMensajeHTML(msg, index) {
                const tieneFrom = msg.from && msg.from !== '';
                const tieneTo = msg.to && msg.to !== '';
                const esEnviado = msg.from === 'YO' || msg.from === 'Yo' || msg.status === 'sent' || (tieneTo && !tieneFrom) || (tieneTo && msg.from !== chatActual);
                const tipo = esEnviado ? 'sent' : 'received';
                const nombre = esEnviado ? 'Bot' : (msg.name || 'Usuario');

                let timestamp = null;
                if (msg.received_at) {
                    timestamp = msg.received_at;
                } else if (msg.timestamp) {
                    if (typeof msg.timestamp === 'number') {
                        timestamp = msg.timestamp < 10000000000 ? new Date(msg.timestamp * 1000).toISOString() : new Date(msg.timestamp).toISOString();
                    } else {
                        timestamp = msg.timestamp;
                    }
                }

                const tiempo = formatearTiempo(timestamp);

                let cuerpo = '';
                if (msg.body) {
                    cuerpo = msg.body.toString();
                    if ((cuerpo === '[interactive]' || cuerpo === '') && msg.type === 'interactive') {
                        if (msg.interactive) {
                            if (msg.interactive.type === 'button_reply') {
                                cuerpo = `🔘 Botón: ${msg.interactive.button_reply?.title || 'Botón presionado'}`;
                            } else if (msg.interactive.type === 'list_reply') {
                                cuerpo = `📋 Lista: ${msg.interactive.list_reply?.title || 'Opción seleccionada'}`;
                            } else {
                                cuerpo = `📱 Mensaje interactivo (${msg.interactive.type || 'interactivo'})`;
                            }
                        } else {
                            cuerpo = '📱 [Mensaje interactivo]';
                        }
                    }
                } else if (msg.text && typeof msg.text === 'object' && msg.text.body) {
                    cuerpo = msg.text.body.toString();
                } else if (msg.text && typeof msg.text === 'string') {
                    cuerpo = msg.text.toString();
                } else if (msg.type) {
                    if (msg.type === 'image') {
                        cuerpo = '🖼️ [Imagen]';
                    } else if (msg.type === 'video') {
                        cuerpo = '🎥 [Video]';
                    } else if (msg.type === 'audio') {
                        cuerpo = '🎵 [Audio]';
                    } else if (msg.type === 'document') {
                        cuerpo = '📄 [Documento]';
                    } else if (msg.type === 'location') {
                        cuerpo = '📍 [Ubicación]';
                    } else if (msg.type === 'sticker') {
                        cuerpo = '😊 [Sticker]';
                    } else {
                        cuerpo = `[${msg.type}] Mensaje multimedia`;
                    }
                } else {
                    cuerpo = 'Sin contenido';
                }

                const cuerpoEscapado = escapeHtml(cuerpo);
                
                // Detectar si el mensaje es solo emojis (sin texto adicional)
                // Un mensaje solo de emojis contiene solo caracteres emoji y espacios
                const cuerpoTrim = cuerpo.trim();
                // Remover espacios y verificar si solo contiene emojis
                const sinEspacios = cuerpoTrim.replace(/\s/g, '');
                // Detectar si es solo emojis (1-5 caracteres, sin letras ni números)
                // Usar una detección más simple y robusta
                const noTieneLetrasNiNumeros = !/[a-zA-Z0-9]/.test(cuerpoTrim);
                const tieneSoloEmojis = noTieneLetrasNiNumeros && 
                                       (/[\p{Emoji_Presentation}\p{Emoji}]/u.test(sinEspacios) || 
                                        /[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{263A}\u{FE0F}]/u.test(sinEspacios));
                const esSoloEmoji = sinEspacios.length > 0 && 
                                   sinEspacios.length <= 5 && 
                                   noTieneLetrasNiNumeros && 
                                   tieneSoloEmojis;

                let imagenHtml = '';
                if (msg.type === 'image') {
                    let imageUrl = '';
                    if (msg.media_url) {
                        imageUrl = msg.media_url;
                    } else if (typeof msg.body === 'string' && msg.body.includes('| URL:')) {
                        const urlMatch = msg.body.match(/\| URL: (https?:\/\/[^\s]+)/);
                        if (urlMatch) {
                            imageUrl = urlMatch[1];
                        }
                    }

                    if (imageUrl) {
                        if (imageUrl.startsWith('data:image') || imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
                            imagenHtml = `<div class="message-image"><img src="${escapeHtml(imageUrl)}" alt="Imagen" onerror="this.parentElement.innerHTML='<span>Imagen no disponible</span>'"></div>`;
                        }
                    }
                }

                const checkIcon = esEnviado ? '<span class="check-icon">✓✓</span>' : '';

            // Si es una imagen y hay imagenHtml, incluir el tiempo dentro de la imagen
            if (imagenHtml && msg.type === 'image') {
                imagenHtml = imagenHtml.replace('</div>', `<div class="message-time">${tiempo} ${checkIcon}</div></div>`);
            }
            
            // Si es una imagen y hay imagenHtml, no mostrar el texto del cuerpo
            const esImagenConImagen = msg.type === 'image' && imagenHtml;
            const mostrarBubble = !esImagenConImagen;

                // Si es solo emojis, mostrar el emoji fuera del bubble y el tiempo dentro
                if (mostrarBubble && esSoloEmoji) {
                    return `
                        <div class="message ${tipo}" data-msg-id="${msg.id || msg.timestamp || index}">
                            ${imagenHtml}
                            <span class="message-emoji">${cuerpoEscapado}</span>
                            <div class="message-bubble message-bubble-time-only"><div class="message-time">${tiempo} ${checkIcon}</div></div>
                        </div>
                    `;
                }

                return `
                    <div class="message ${tipo}" data-msg-id="${msg.id || msg.timestamp || index}">
                        ${imagenHtml}
                    ${mostrarBubble ? `<div class="message-bubble">${cuerpoEscapado}<div class="message-time">${tiempo} ${checkIcon}</div></div>` : ''}
                    </div>
                `;
        }

        let selectedImageUrl = null;

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImageUrl = e.target.result;
                document.getElementById('previewImg').src = selectedImageUrl;
                document.getElementById('imageUrlText').textContent = file.name + ' (' + (file.size / 1024).toFixed(2) + ' KB)';
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function clearImagePreview() {
            selectedImageUrl = null;
            document.getElementById('imageInput').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        function agregarMensajeEnviadoInmediato(mensajeTexto, imagenUrl) {
            const container = document.getElementById('chatMessages');
            
            // Verificar si el contenedor tiene el empty-state y removerlo
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const tiempo = formatearTiempo(new Date().toISOString());
            const checkIcon = '<span class="check-icon">✓✓</span>';
            const tempId = `temp-${Date.now()}`;
            
            let mensajeHtml = '';
            
            if (imagenUrl) {
                // Es una imagen
                const imagenHtml = `<div class="message-image"><img src="${escapeHtml(imagenUrl)}" alt="Imagen" onerror="this.parentElement.innerHTML='<span>Imagen no disponible</span>'"><div class="message-time">${tiempo} ${checkIcon}</div></div>`;
                mensajeHtml = `
                    <div class="message sent" data-msg-id="${tempId}" data-temp-status="sending">
                        ${imagenHtml}
                    </div>
                `;
            } else if (mensajeTexto) {
                // Es texto
                const cuerpoEscapado = escapeHtml(mensajeTexto);
                const cuerpoTrim = mensajeTexto.trim();
                const sinEspacios = cuerpoTrim.replace(/\s/g, '');
                const noTieneLetrasNiNumeros = !/[a-zA-Z0-9]/.test(cuerpoTrim);
                const tieneSoloEmojis = noTieneLetrasNiNumeros && 
                                       (/[\p{Emoji_Presentation}\p{Emoji}]/u.test(sinEspacios) || 
                                        /[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{263A}\u{FE0F}]/u.test(sinEspacios));
                const esSoloEmoji = sinEspacios.length > 0 && 
                                   sinEspacios.length <= 5 && 
                                   noTieneLetrasNiNumeros && 
                                   tieneSoloEmojis;
                
                if (esSoloEmoji) {
                    // Si es solo emojis, mostrar el emoji fuera del bubble y el tiempo dentro
                    mensajeHtml = `
                        <div class="message sent" data-msg-id="${tempId}" data-temp-status="sending">
                            <span class="message-emoji">${cuerpoEscapado}</span>
                            <div class="message-bubble message-bubble-time-only"><div class="message-time">${tiempo} ${checkIcon}</div></div>
                        </div>
                    `;
                } else {
                    mensajeHtml = `
                        <div class="message sent" data-msg-id="${tempId}" data-temp-status="sending">
                            <div class="message-bubble">${cuerpoEscapado}<div class="message-time">${tiempo} ${checkIcon}</div></div>
                        </div>
                    `;
                }
            }
            
            if (mensajeHtml) {
                container.insertAdjacentHTML('beforeend', mensajeHtml);
                
                // Scroll al final
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 10);
                
                // Retornar el ID temporal para poder actualizarlo después
                return tempId;
            }
            return null;
        }
        
        function actualizarEstadoMensaje(tempId, exito) {
            const container = document.getElementById('chatMessages');
            const tempElement = container.querySelector(`[data-msg-id="${tempId}"]`);
            
            if (!tempElement) return;
            
            const timeElement = tempElement.querySelector('.message-time');
            if (!timeElement) return;
            
            if (exito) {
                // Si fue exitoso, solo actualizar el estado internamente sin cambiar nada visual
                tempElement.setAttribute('data-temp-status', 'sent');
                // No cambiar el texto - se mantiene "Just now" hasta que se recargue
            } else {
                // Si falló, solo cambiar el texto del estado sin animación
                const checkIcon = '<span class="check-icon" style="color: #dc3545;">✕</span>';
                timeElement.innerHTML = `No enviado ${checkIcon}`;
                tempElement.setAttribute('data-temp-status', 'failed');
            }
        }

        function enviarMensaje() {
            const mensaje = document.getElementById('messageInput').value.trim();
            if ((!mensaje && !selectedImageUrl) || !chatActual) return;

            // Guardar valores antes de limpiar
            const mensajeTexto = mensaje;
            const imagenUrlTemp = selectedImageUrl;

            // Agregar mensaje inmediatamente a la vista y guardar el ID temporal
            const tempId = agregarMensajeEnviadoInmediato(mensajeTexto, imagenUrlTemp);

            // Limpiar el input inmediatamente
            document.getElementById('messageInput').value = '';
            document.getElementById('messageInput').style.height = 'auto';
            clearImagePreview();

            // NO bloquear el botón - permitir enviar múltiples mensajes seguidos

            const form = document.getElementById('hiddenForm');
            const iframe = document.getElementById('hiddenIframe');

            form.action = SCRIPT_URL;
            document.getElementById('formAction').value = 'sendMessage';
            document.getElementById('formTo').value = chatActual;
            document.getElementById('formMessage').value = mensajeTexto || '';
            document.getElementById('formImageUrl').value = imagenUrlTemp || '';

            let iframeLoaded = false;
            const handleIframeLoad = function() {
                if (iframeLoaded) return;
                iframeLoaded = true;

                try {
                    let responseText = '';
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        responseText = iframeDoc.body ? iframeDoc.body.innerText || iframeDoc.body.textContent : '';
                    } catch (e) {
                        responseText = 'OK';
                    }

                    let data = { success: true };
                    try {
                        data = JSON.parse(responseText);
                    } catch (e) {
                        if (responseText.trim() === 'OK' || responseText.trim().includes('✅')) {
                            data = { success: true };
                        } else if (responseText.trim().includes('error') || responseText.trim().includes('Error')) {
                            data = { success: false, error: responseText.substring(0, 100) };
                        }
                    }

                    if (data.success) {
                        // Si fue exitoso, solo actualizar el estado internamente sin cambios visuales
                        if (tempId) {
                            actualizarEstadoMensaje(tempId, true);
                        }
                        // NO recargar mensajes - el mensaje temporal ya está mostrado
                        // Solo actualizar la lista de chats
                        setTimeout(() => {
                            cargarChats();
                        }, 500);
                    } else {
                        // Si falló, actualizar el estado a "no enviado" sin animación
                        if (tempId) {
                            actualizarEstadoMensaje(tempId, false);
                        }
                        alert('Error al enviar mensaje: ' + (data.error || 'Error desconocido'));
                    }
                } catch (error) {
                    // Si hubo error, marcar como no enviado
                    if (tempId) {
                        actualizarEstadoMensaje(tempId, false);
                    }
                    // NO recargar mensajes - mantener el mensaje temporal con estado "no enviado"
                    setTimeout(() => {
                        cargarChats();
                    }, 500);
                }

                // NO restaurar el botón porque nunca se bloqueó
                iframe.removeEventListener('load', handleIframeLoad);
                iframeLoaded = false;
            };

            iframe.addEventListener('load', handleIframeLoad);
            form.submit();

            setTimeout(() => {
                if (iframeLoaded === false) {
                    iframeLoaded = true;
                    // NO restaurar el botón porque nunca se bloqueó
                    // Si no se recibió respuesta en 10 segundos, marcar como no enviado
                    if (tempId) {
                        actualizarEstadoMensaje(tempId, false);
                    }
                    // NO recargar mensajes - mantener el mensaje temporal con estado "no enviado"
                    setTimeout(() => {
                        cargarChats();
                    }, 500);
                    iframe.removeEventListener('load', handleIframeLoad);
                }
            }, 10000);
        }

        // ============================================
        // FUNCIONES DE CONFIGURACIÓN DEL BOT
        // ============================================

        function mostrarVistaMensajes() {
            // Ocultar todas las áreas
            const chatArea = document.getElementById('chatArea');
            const chatsSidebar = document.querySelector('.chats-sidebar');
            const navSidebar = document.querySelector('.nav-sidebar');
            const isMobile = window.innerWidth <= 768;
            
            // En móvil: mostrar lista de chats y nav-sidebar, ocultar chat
            if (isMobile) {
                if (chatsSidebar) {
                    chatsSidebar.style.display = 'block';
                }
                if (navSidebar) {
                    navSidebar.style.display = 'flex';
                }
                chatArea.classList.remove('active');
                chatArea.style.display = 'none';
            } else {
                // En desktop: comportamiento normal
                chatArea.style.display = 'flex';
            }
            
            // Mostrar el top-header cuando se vuelve a la vista de chats
            const topHeader = document.querySelector('.top-header');
            if (topHeader) {
                topHeader.classList.remove('hidden');
            }
            
            document.getElementById('configArea').style.display = 'none';
            document.getElementById('statsArea').style.display = 'none';
            
            // Actualizar iconos activos
            document.querySelectorAll('.nav-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            document.querySelectorAll('.nav-icon')[0].classList.add('active');
        }

        function mostrarVistaEstadisticas() {
            // Ocultar todas las áreas
            const chatArea = document.getElementById('chatArea');
            const configArea = document.getElementById('configArea');
            const statsArea = document.getElementById('statsArea');
            const chatsSidebar = document.querySelector('.chats-sidebar');
            const isMobile = window.innerWidth <= 768;
            
            // En móvil: ocultar sidebar y mostrar stats
            if (isMobile) {
                if (chatsSidebar) {
                    chatsSidebar.style.display = 'none';
                }
                chatArea.classList.remove('active');
                chatArea.style.display = 'none';
            } else {
                // En desktop: comportamiento normal
                chatArea.style.display = 'none';
            }
            
            // Mostrar el top-header cuando se entra a estadísticas
            const topHeader = document.querySelector('.top-header');
            if (topHeader) {
                topHeader.classList.remove('hidden');
            }
            
            configArea.style.display = 'none';
            statsArea.style.display = 'flex';
            
            // Actualizar iconos activos
            document.querySelectorAll('.nav-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            document.querySelectorAll('.nav-icon')[2].classList.add('active');
            
            // Cargar estadísticas
            cargarEstadisticas();
        }

        function cargarEstadisticas() {
            const LIMITE_DIARIO = 20000;
            
            // Obtener fecha de hoy (solo día, mes y año, sin hora)
            const ahora = new Date();
            const añoHoy = ahora.getFullYear();
            const mesHoy = ahora.getMonth();
            const diaHoy = ahora.getDate();
            
            let mensajesUsados = 0;
            let mensajesMes = 0;
            const chatsActivosSet = new Set();
            
            // Iterar sobre todos los chats
            if (chats && Array.isArray(chats)) {
                chats.forEach(chat => {
                    if (chat.messages && Array.isArray(chat.messages)) {
                        let tieneMensajeReciente = false;
                        
                        chat.messages.forEach(msg => {
                            if (!msg) return;
                            
                            // Obtener timestamp del mensaje
                            let fechaMsg = null;
                            if (msg.received_at) {
                                fechaMsg = new Date(msg.received_at);
                            } else if (msg.timestamp) {
                                if (typeof msg.timestamp === 'number') {
                                    // Si es timestamp en segundos, convertir a milisegundos
                                    fechaMsg = msg.timestamp < 10000000000 
                                        ? new Date(msg.timestamp * 1000) 
                                        : new Date(msg.timestamp);
                                } else {
                                    fechaMsg = new Date(msg.timestamp);
                                }
                            }
                            
                            if (fechaMsg && !isNaN(fechaMsg.getTime())) {
                                // Obtener día, mes y año del mensaje (hora local)
                                const añoMsg = fechaMsg.getFullYear();
                                const mesMsg = fechaMsg.getMonth();
                                const diaMsg = fechaMsg.getDate();
                                
                                // Contar mensajes del día (comparar solo día, mes y año)
                                if (añoMsg === añoHoy && mesMsg === mesHoy && diaMsg === diaHoy) {
                                    mensajesUsados++;
                                    tieneMensajeReciente = true;
                                }
                                
                                // Contar mensajes del mes (comparar mes y año)
                                if (añoMsg === añoHoy && mesMsg === mesHoy) {
                                    mensajesMes++;
                                }
                            }
                        });
                        
                        // Si tiene mensajes recientes (últimas 24 horas), es un chat activo
                        if (tieneMensajeReciente && chat.phone) {
                            chatsActivosSet.add(chat.phone.toString());
                        }
                    }
                });
            }
            
            const chatsActivos = chatsActivosSet.size;
            
            // Actualizar otros valores
            // mensajesMes es fijo: 600,000 (20,000 * 30 días)
            document.getElementById('chatsActivos').textContent = chatsActivos.toLocaleString();
            
            // Actualizar datos de agente humano
            const AGENTES_PERMITIDOS = 3;
            const LIMITE_HORAS_DIA = 8;
            const LLAMADAS_DIARIAS_API = 20000;
            const INTERVALO_ACTUALIZACION = 5; // segundos
            
            // Calcular cuántas llamadas se hacen por hora con 3 agentes simultáneos
            // Cada agente actualiza cada 5 segundos, entonces 3 agentes = 3 llamadas cada 5 segundos
            const llamadasPorSegundo = AGENTES_PERMITIDOS / INTERVALO_ACTUALIZACION; // 0.6 llamadas/segundo
            const llamadasPorHora = llamadasPorSegundo * 3600; // 2,160 llamadas/hora (3 agentes)
            const llamadasPorDia = llamadasPorHora * LIMITE_HORAS_DIA; // 17,280 llamadas/día (3 agentes × 8 horas)
            
            // Calcular cuánto tardaría en acabarse las 20,000 llamadas
            const horasDisponibles = LLAMADAS_DIARIAS_API / llamadasPorHora; // ~9.26 horas con 3 agentes
            const diasDisponibles = horasDisponibles / LIMITE_HORAS_DIA; // ~1.16 días con 3 agentes × 8h/día
            
            // Actualizar valores en la UI
            document.getElementById('agentesPermitidos').textContent = AGENTES_PERMITIDOS.toString();
            document.getElementById('limiteHoras').textContent = `${LIMITE_HORAS_DIA} horas/día`;
            
            // Actualizar advertencia con información del límite
            const warningElement = document.getElementById('warningText');
            if (warningElement) {
                warningElement.textContent = `Máximo ${AGENTES_PERMITIDOS} agentes pueden conectarse simultáneamente al mismo usuario.`;
            }
        }

        function mostrarVistaConfiguracion() {
            // Ocultar todas las áreas
            const chatArea = document.getElementById('chatArea');
            const configArea = document.getElementById('configArea');
            const statsArea = document.getElementById('statsArea');
            const chatsSidebar = document.querySelector('.chats-sidebar');
            const configOverlay = document.getElementById('configMobileOverlay');
            const isMobile = window.innerWidth <= 768;
            
            // En móvil: ocultar sidebar y mostrar config
            if (isMobile) {
                if (chatsSidebar) {
                    chatsSidebar.style.display = 'none';
                }
                chatArea.classList.remove('active');
                chatArea.style.display = 'none';
                // Mostrar overlay en móvil
                if (configOverlay) {
                    configOverlay.style.display = 'flex';
                }
            } else {
                // En desktop: comportamiento normal
                chatArea.style.display = 'none';
                // Ocultar overlay en desktop
                if (configOverlay) {
                    configOverlay.style.display = 'none';
                }
            }
            
            // Mostrar el top-header cuando se entra a configuración
            const topHeader = document.querySelector('.top-header');
            if (topHeader) {
                topHeader.classList.remove('hidden');
            }
            
            configArea.style.display = 'flex';
            statsArea.style.display = 'none';
            
            // Actualizar iconos activos
            document.querySelectorAll('.nav-icon').forEach(icon => icon.classList.remove('active'));
            document.querySelectorAll('.nav-icon')[1].classList.add('active');
            
            cargarConfiguracion();
        }

        function cerrarConfigOverlay() {
            const overlay = document.getElementById('configMobileOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function cargarConfiguracion() {
            const container = document.getElementById('configTableContainer');
            const loading = document.getElementById('configLoading');
            
            loading.style.display = 'block';
            container.style.display = 'none';

            fetch(CONFIG_URL + '?action=get_config')
                .then(response => response.text())
                .then(text => {
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        if (text.trim() === 'OK' || text.trim() === '') {
                            data = { config: [] };
                        } else {
                            throw new Error('Respuesta no válida');
                        }
                    }

                    if (data.config && Array.isArray(data.config)) {
                        // Guardar configuración original para comparar cambios
                        configOriginal = JSON.parse(JSON.stringify(data.config));
                        mostrarConfiguracion(data.config);
                    } else {
                        configOriginal = [];
                        mostrarConfiguracion([]);
                    }

                    loading.style.display = 'none';
                    container.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error al cargar configuración:', error);
                    loading.innerHTML = `<p>Error al cargar configuración: ${error.message}</p>`;
                });
        }

        function mostrarConfiguracion(config) {
            const thead = document.getElementById('configTableHeader');
            const tbody = document.getElementById('configTableBody');
            
            // Filtrar filas innecesarias: eliminar filas con keywords vacías o que solo tienen texto de lista
            // Pero mantener el índice original para poder actualizar correctamente
            const configFiltrado = [];
            config.forEach((row, originalIndex) => {
                const keywords = String(row.keywords || '').trim();
                const responses = String(row.responses || '').trim();
                
                // Eliminar filas con keywords vacías
                if (!keywords) {
                    return;
                }
                
                // Eliminar filas que solo tienen texto de lista (empiezan con "-") sin keywords válidas
                if (responses && responses.trim().startsWith('-') && !keywords) {
                    return;
                }
                
                // Agregar fila con su índice original
                configFiltrado.push({
                    ...row,
                    _originalIndex: originalIndex
                });
            });
            
            // Determinar las columnas dinámicamente desde los datos filtrados
            let columnas = [];
            if (configFiltrado.length > 0) {
                // Obtener todas las claves posibles de los objetos (excluyendo _originalIndex)
                const todasLasClaves = new Set();
                configFiltrado.forEach(row => {
                    Object.keys(row).forEach(key => {
                        if (key !== '_originalIndex') {
                            todasLasClaves.add(key);
                        }
                    });
                });
                columnas = Array.from(todasLasClaves);
            } else {
                // Si no hay datos, usar las columnas por defecto
                columnas = ['keywords', 'responses', 'options'];
            }
            
            // Crear encabezados dinámicamente
            thead.innerHTML = `
                <tr>
                    ${columnas.map(col => `<th>${escapeHtml(col)}</th>`).join('')}
                    <th>Acciones</th>
                </tr>
            `;
            
            if (configFiltrado.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${columnas.length + 1}" style="text-align: center; padding: 40px; color: #65676b;">
                            No hay configuración. Agrega una nueva fila para comenzar.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = configFiltrado.map((row, index) => {
                const originalIndex = row._originalIndex;
                const celdas = columnas.map(col => {
                    const valor = escapeHtml(row[col] || '');
                    return `
                        <td>
                            <textarea class="config-input" data-field="${col}" rows="2" data-original="${escapeHtml(String(row[col] || ''))}">${valor}</textarea>
                        </td>
                    `;
                }).join('');
                
                return `
                    <tr data-row-index="${index}" data-original-index="${originalIndex}">
                        ${celdas}
                        <td>
                            <div class="config-actions">
                                <button class="config-btn config-btn-delete" onclick="eliminarFilaConfiguracion(${index})">Eliminar</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function agregarFilaConfiguracion() {
            const tbody = document.getElementById('configTableBody');
            const thead = document.getElementById('configTableHeader');
            
            // Si está vacío, limpiar el mensaje
            if (tbody.children.length === 1 && tbody.children[0].querySelector('td[colspan]')) {
                tbody.innerHTML = '';
            }
            
            // Obtener las columnas desde los encabezados
            const headerCells = thead.querySelectorAll('th');
            const columnas = [];
            headerCells.forEach(th => {
                const colName = th.textContent.trim();
                if (colName !== 'Acciones') {
                    columnas.push(colName);
                }
            });
            
            // Si no hay columnas definidas, usar las por defecto
            if (columnas.length === 0) {
                columnas.push('keywords', 'responses', 'options');
            }
            
            const newRow = document.createElement('tr');
            // Nueva fila no tiene data-original-index
            const celdas = columnas.map(col => {
                return `
                    <td>
                        <textarea class="config-input" data-field="${col}" rows="2" data-original="" placeholder="Ingresa ${col}"></textarea>
                    </td>
                `;
            }).join('');
            
            newRow.innerHTML = `
                ${celdas}
                <td>
                    <div class="config-actions">
                        <button class="config-btn config-btn-delete" onclick="eliminarFilaConfiguracion(this)">Eliminar</button>
                    </div>
                </td>
            `;
            tbody.appendChild(newRow);
        }

        function eliminarFilaConfiguracion(indexOrButton) {
            if (typeof indexOrButton === 'number') {
                const rows = document.querySelectorAll('#configTableBody tr');
                if (rows[indexOrButton]) {
                    rows[indexOrButton].remove();
                }
            } else {
                indexOrButton.closest('tr').remove();
            }
            
            // Si no hay filas, mostrar mensaje
            const tbody = document.getElementById('configTableBody');
            const thead = document.getElementById('configTableHeader');
            const headerCells = thead.querySelectorAll('th');
            const numColumnas = headerCells.length;
            
            if (tbody.children.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${numColumnas}" style="text-align: center; padding: 40px; color: #65676b;">
                            No hay configuración. Agrega una nueva fila para comenzar.
                        </td>
                    </tr>
                `;
            }
        }

        function guardarConfiguracion() {
            const tbody = document.getElementById('configTableBody');
            const thead = document.getElementById('configTableHeader');
            const rows = tbody.querySelectorAll('tr:not([style*="text-align: center"])');
            
            // Obtener las columnas dinámicamente desde los encabezados
            const headerCells = thead.querySelectorAll('th');
            const columnas = [];
            headerCells.forEach(th => {
                const colName = th.textContent.trim();
                if (colName !== 'Acciones') {
                    columnas.push(colName);
                }
            });
            
            // Obtener configuración actual
            const configActual = [];
            
            rows.forEach((row, rowIndex) => {
                const rowData = {};
                let tieneDatos = false;
                
                columnas.forEach(col => {
                    const input = row.querySelector(`[data-field="${col}"]`);
                    if (input) {
                        const valor = input.value.trim();
                        rowData[col] = valor;
                        if (valor) {
                            tieneDatos = true;
                        }
                    }
                });
                
                if (tieneDatos) {
                    rowData._rowIndex = rowIndex;
                    const originalIndex = row.getAttribute('data-original-index');
                    if (originalIndex !== null) {
                        rowData._originalIndex = parseInt(originalIndex);
                    }
                    configActual.push(rowData);
                }
            });

            // Detectar cambios: filas nuevas, modificadas y eliminadas
            const filasNuevas = [];
            const filasModificadas = [];
            const filasEliminadas = [];
            
            // Filas nuevas: no tienen _originalIndex
            configActual.forEach(row => {
                if (row._originalIndex === undefined) {
                    filasNuevas.push(row);
                }
            });
            
            // Filas modificadas: tienen _originalIndex pero el contenido cambió
            configActual.forEach(row => {
                if (row._originalIndex !== undefined) {
                    const original = configOriginal[row._originalIndex];
                    if (original) {
                        let cambio = false;
                        columnas.forEach(col => {
                            const valorActual = String(row[col] || '').trim();
                            const valorOriginal = String(original[col] || '').trim();
                            if (valorActual !== valorOriginal) {
                                cambio = true;
                            }
                        });
                        if (cambio) {
                            filasModificadas.push({
                                index: row._originalIndex,
                                data: row
                            });
                        }
                    }
                }
            });
            
            // Filas eliminadas: estaban en original pero no en actual
            configOriginal.forEach((original, index) => {
                const keywords = String(original.keywords || '').trim();
                // Solo considerar filas con keywords (las que se muestran)
                if (keywords) {
                    const existe = configActual.some(row => row._originalIndex === index);
                    if (!existe) {
                        filasEliminadas.push(index);
                    }
                }
            });
            
            // Si no hay cambios, no hacer nada
            if (filasNuevas.length === 0 && filasModificadas.length === 0 && filasEliminadas.length === 0) {
                mostrarModal('Sin cambios', 'No hay cambios para guardar', 'info');
                return;
            }
            
            // Guardar cambios
            guardarCambiosConfiguracion(filasNuevas, filasModificadas, filasEliminadas, columnas);
        }
        
        function guardarCambiosConfiguracion(filasNuevas, filasModificadas, filasEliminadas, columnas) {
            const form = document.getElementById('hiddenForm');
            const iframe = document.getElementById('hiddenIframe');
            let cambiosPendientes = filasNuevas.length + filasModificadas.length + filasEliminadas.length;
            let cambiosCompletados = 0;
            let errores = [];
            
            const handleCompletion = () => {
                cambiosCompletados++;
                if (cambiosCompletados >= cambiosPendientes) {
                    if (errores.length > 0) {
                        mostrarModal('Error al guardar', 'Guardado con algunos errores:\n' + errores.join('\n'), 'error');
                    } else {
                        mostrarModal('Configuración guardada', 'Los cambios se han guardado correctamente', 'success');
                        // Recargar configuración para actualizar configOriginal
                        setTimeout(() => {
                            cargarConfiguracion();
                        }, 1000);
                    }
                }
            };
            
            // Eliminar filas eliminadas
            filasEliminadas.forEach(index => {
                const formData = new FormData();
                formData.append('action', 'delete_row');
                formData.append('row_index', index);
                
                fetch(CONFIG_URL, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(text => {
                    try {
                        const data = JSON.parse(text);
                        if (!data.success) {
                            errores.push(`Error al eliminar fila ${index}: ${data.error}`);
                        }
                    } catch (e) {
                        errores.push(`Error al eliminar fila ${index}`);
                    }
                    handleCompletion();
                })
                .catch(error => {
                    errores.push(`Error al eliminar fila ${index}: ${error.message}`);
                    handleCompletion();
                });
            });
            
            // Actualizar filas modificadas
            filasModificadas.forEach(({index, data}) => {
                const formData = new FormData();
                formData.append('action', 'update_row');
                formData.append('row_index', index);
                
                columnas.forEach(col => {
                    formData.append(col, data[col] || '');
                });
                
                fetch(CONFIG_URL, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(text => {
                    try {
                        const data = JSON.parse(text);
                        if (!data.success) {
                            errores.push(`Error al actualizar fila ${index}: ${data.error}`);
                        }
                    } catch (e) {
                        errores.push(`Error al actualizar fila ${index}`);
                    }
                    handleCompletion();
                })
                .catch(error => {
                    errores.push(`Error al actualizar fila ${index}: ${error.message}`);
                    handleCompletion();
                });
            });
            
            // Agregar filas nuevas
            filasNuevas.forEach(row => {
                const formData = new FormData();
                formData.append('action', 'add_row');
                
                columnas.forEach(col => {
                    formData.append(col, row[col] || '');
                });
                
                fetch(CONFIG_URL, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(text => {
                    try {
                        const data = JSON.parse(text);
                        if (!data.success) {
                            errores.push(`Error al agregar fila: ${data.error}`);
                        }
                    } catch (e) {
                        errores.push(`Error al agregar fila`);
                    }
                    handleCompletion();
                })
                .catch(error => {
                    errores.push(`Error al agregar fila: ${error.message}`);
                    handleCompletion();
                });
            });
            
            // Si no hay cambios pendientes, completar inmediatamente
            if (cambiosPendientes === 0) {
                handleCompletion();
            }
        }

        function togglePausaBot(phone) {
            if (!phone) return;
            const phoneStr = phone.toString();
            const pausado = !window.chatsPausados[phoneStr];

            const form = new FormData();
            form.append('action', 'togglePausaBot');
            form.append('phone', phoneStr);
            form.append('pausado', pausado ? '1' : '0');

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: form
            })
            .then(response => response.text())
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    if (data.success) {
                        window.chatsPausados[phoneStr] = pausado;
                        const pauseBtnImg = document.getElementById('pauseBtnImg');
                        if (pauseBtnImg) {
                            pauseBtnImg.src = pausado ? 'images/play.png' : 'images/pausa.png';
                        }
                        mostrarChats();
                    }
                } catch (e) {
                    window.chatsPausados[phoneStr] = pausado;
                    document.getElementById('pauseBtn').innerHTML = pausado ? '▶️' : '⏸️';
                    mostrarChats();
                }
            })
            .catch(error => {
                console.error('Error al cambiar pausa:', error);
            });
        }
    </script>
    </div> <!-- Cierre del mainContent -->
</body>
</html>
